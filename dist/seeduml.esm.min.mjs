function _(P){if(!P)return"";let n=P.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");return n=n.replace(/&lt;b&gt;(.*?)&lt;\/b&gt;/gi,'<tspan font-weight="bold">$1</tspan>'),n=n.replace(/&lt;u&gt;(.*?)&lt;\/u&gt;/gi,'<tspan text-decoration="underline">$1</tspan>'),n=n.replace(/&lt;i&gt;(.*?)&lt;\/i&gt;/gi,'<tspan font-style="italic">$1</tspan>'),n=n.replace(/&lt;s&gt;(.*?)&lt;\/s&gt;/gi,'<tspan text-decoration="line-through">$1</tspan>'),n=n.replace(/&lt;font\s+color=(?:&quot;)?(.*?)(?:&quot;)?&gt;(.*?)&lt;\/font&gt;/gi,'<tspan fill="$1">$2</tspan>'),n=n.replace(/&lt;b&gt;(?!.*&lt;\/b&gt;)(.*)/gi,'<tspan font-weight="bold">$1</tspan>'),n=n.replace(/&lt;font\s+color=(?:&quot;)?(.*?)(?:&quot;)?&gt;(?!.*&lt;\/font&gt;)(.*)/gi,'<tspan fill="$1">$2</tspan>'),n=n.replace(/\*\*(.*?)\*\*/g,'<tspan font-weight="bold">$1</tspan>'),n=n.replace(/\/\/(.*?)\/\//g,'<tspan font-style="italic">$1</tspan>'),n=n.replace(/""(.*?)""/g,'<tspan font-family="monospace">$1</tspan>'),n=n.replace(/--(.*?)--/g,'<tspan text-decoration="line-through">$1</tspan>'),n=n.replace(/__(.*?)__/g,'<tspan text-decoration="underline">$1</tspan>'),n=n.replace(/~~(.*?)~~/g,'<tspan style="text-decoration: underline; text-decoration-style: wavy">$1</tspan>'),n}function gt(P){return P?P.replace(/<U\+([0-9a-fA-F]{4})>/g,(n,t)=>String.fromCharCode(parseInt(t,16))):""}var it=class{constructor(){this.type="sequence";this.participants=[];this.messages=[];this.activations=[];this.groups=[];this.references=[];this.notes=[];this.dividers=[];this.delays=[];this.spacings=[];this.timeConstraints=[];this.taggedSteps=new Map;this.hideFootbox=!1;this.currentStep=0;this.groupStack=[];this.autonumberConfig=null;this.currentAutonumbers=[0];this.autonumberDelimiter=".";this.autonumberStopped=!1;this.autoactivateEnabled=!1}setHideFootbox(n){this.hideFootbox=n}addParticipant(n,t,e="participant",i,o,s){let a=this.participants.find(c=>c.name===n);a?(t&&(a.label=t),e!=="participant"&&(a.type=e),i!==void 0&&(a.order=i),o&&(a.color=o),s&&(a.stereotype=s)):(a={name:n,label:t,type:e,order:i,color:o,stereotype:s},this.participants.push(a)),this.groupStack.forEach(c=>{c.participants.includes(n)||c.participants.push(n)})}addMessage(n,t,e,i="arrow",o="default",s,a,c="none"){let r=this.currentStep++;this.addParticipant(n),this.addParticipant(t);let l;if(this.autonumberConfig&&!this.autonumberStopped){this.currentAutonumbers[this.currentAutonumbers.length-1]+=this.autonumberConfig.increment;let f=this.currentAutonumbers.join(this.autonumberDelimiter);this.autonumberConfig.format?l=this.autonumberConfig.format.replace(/%d/g,f):l=f}let d=this.currentAutonumbers.join(this.autonumberDelimiter);return e=e.replace(/%autonumber%/g,d),e=gt(e),this.messages.push({from:n,to:t,text:e,type:i,step:r,arrowHead:o,startHead:c,color:s,bidirectional:a,number:l}),this.autoactivateEnabled&&n!==t&&i==="arrow"&&this.activate(t,r,r),r}setAutonumber(n=1,t=1,e){if(this.autonumberConfig={start:typeof n=="number"?n:1,increment:t,format:e},this.autonumberStopped=!1,typeof n=="string"){let i=n.split(/([.,;:])/);i.length>1?(this.autonumberDelimiter=i[1],this.currentAutonumbers=i.filter((o,s)=>s%2===0).map(o=>parseInt(o,10))):this.currentAutonumbers=[parseInt(n,10)]}else this.currentAutonumbers=[n];this.currentAutonumbers[this.currentAutonumbers.length-1]-=t}incrementAutonumberLevel(n){if(!this.autonumberConfig)return;let t=n.toUpperCase().charCodeAt(0)-65;if(t>=0&&t<this.currentAutonumbers.length){this.currentAutonumbers[t]++;for(let e=t+1;e<this.currentAutonumbers.length;e++)this.currentAutonumbers[e]=1;this.currentAutonumbers[this.currentAutonumbers.length-1]-=this.autonumberConfig.increment}}stopAutonumber(){this.autonumberStopped=!0}resumeAutonumber(n,t){this.autonumberConfig?(this.autonumberStopped=!1,n!==void 0&&(this.autonumberConfig.increment=n),t!==void 0&&(this.autonumberConfig.format=t)):this.setAutonumber(1,n||1,t)}setAutoactivate(n){this.autoactivateEnabled=n}destroy(n,t){let e=this.participants.find(i=>i.name===n);e&&(e.destroyedStep=t!==void 0?t:this.currentStep++,this.deactivate(n,e.destroyedStep))}create(n,t){let e=this.participants.find(i=>i.name===n);e&&(e.createdStep=t)}addDivider(n){this.dividers.push({label:n,step:this.currentStep++})}rewindStep(){this.currentStep>0&&this.currentStep--}nextStep(){return this.currentStep++}getCurrentStep(){return this.currentStep}addDelay(n){this.delays.push({text:n,step:this.currentStep++})}addSpacing(n=30){this.spacings.push({height:n,step:this.currentStep++})}setTitle(n){this.title=n}setHeader(n){this.header=n}setFooter(n){this.footer=n}returnMessage(n){let t=[...this.activations].reverse().find(s=>s.endStep===void 0);if(!t)return;let e=t.participantName,i=e;if(t.sourceStep!==void 0){let s=this.messages.find(a=>a.step===t.sourceStep);s&&(i=s.from)}let o=this.addMessage(e,i,n,"dotted","open");this.deactivate(e,o)}addNote(n,t,e,i,o="folder",s){let a=s!==void 0?s:this.currentStep++,c=this.groupStack.length>0?this.groupStack[this.groupStack.length-1]:void 0,r=this.currentAutonumbers.join(this.autonumberDelimiter);return n=n.replace(/%autonumber%/g,r),n=gt(n),this.notes.push({text:n,position:t,participants:e,step:a,color:i,shape:o,owner:c}),a}activate(n,t=this.currentStep,e,i){this.addParticipant(n);let o=this.activations.filter(s=>s.participantName===n&&s.endStep===void 0).length;this.activations.push({participantName:n,startStep:t,level:o,sourceStep:e,color:i})}deactivate(n,t=this.currentStep,e){this.addParticipant(n);let i=[...this.activations].reverse().find(o=>o.participantName===n&&o.endStep===void 0);i&&(i.endStep=t,i.endSourceStep=e)}startGroup(n,t){let e=this.nextStep(),i={type:n,label:t,startStep:e,sections:[],level:this.groupStack.length,participants:[]};return this.groups.push(i),this.groupStack.push(i),i}addGroupSection(n){let t=this.groupStack[this.groupStack.length-1];t&&t.sections.push({label:n,startStep:this.nextStep()})}endGroup(){let n=this.groupStack.pop();n&&(n.endStep=this.nextStep())}addReference(n,t){let e=this.nextStep(),i=this.nextStep();this.references.push({participants:n,label:t,startStep:e,endStep:i})}addTaggedStep(n,t){this.taggedSteps.set(n,t)}addTimeConstraint(n,t,e){this.timeConstraints.push({startTag:n,endTag:t,label:e})}};var ot=class{parse(n){let t=new it,e=n.split(`
`),i=null,o=null,s=-1,a="",c="",r="",l=new Map;for(let d=0;d<e.length;d++){let f=e[d],h=f;if(f=f.trim(),!f||f.startsWith("@")||f.startsWith("!pragma"))continue;if(o){let D=f.toLowerCase();if(D.startsWith("end note")||(D==="end hnote"||D==="endhnote")||(D==="end rnote"||D==="endrnote")||(D==="end bnote"||D==="endbnote")){let N=o.position.toLowerCase(),G;if(o.participants.length===0&&(N==="right"||N==="left")&&a&&c){let Y=t.participants.findIndex(U=>U.name===a),H=t.participants.findIndex(U=>U.name===c);if(Y!==-1&&H!==-1){let U=t.participants[Y],O=t.participants[H],V=Y<H;U.order!==void 0&&O.order!==void 0&&(V=U.order<O.order),N==="left"?o.participants=[V?a:c]:o.participants=[V?c:a]}else o.participants=[c];s!==-1&&(G=s)}let F=o.text.join(`
`).replace(/\\n/g,`
`);t.addNote(F,o.position,o.participants,o.color,o.shape,G),o=null}else o.text.push(h);continue}if(i){f.toLowerCase().startsWith("end ref")?(t.addReference(i.participants,i.label.join(`
`)),i=null):i.label.push(h);continue}if(f.startsWith("'"))continue;let p=!1;f.startsWith("/")&&(p=!0,f=f.substring(1).trim(),t.rewindStep());let $=f.match(/^create\s+(?:(actor|boundary|control|entity|database|collections)\s+)?(\w+)$/i);if($){let[,D,C]=$;t.addParticipant(C,D),t.create(C,t.getCurrentStep());continue}let g=f.match(/^(activate|deactivate|destroy)\s+(".*?"|\w+)(?:\s+(#\w+))?$/i);if(g){let[,D,C,z]=g,I=C.replace(/^"(.*)"$/,"$1");if(z&&z.startsWith("#")){let N=z.substring(1);/^[0-9A-Fa-f]+$/.test(N)&&[3,4,6,8].includes(N.length)||(z=N)}let W=D.toLowerCase();if(W==="activate")if(I===c&&s!==-1)t.activate(I,s,s,z),l.set(I,s);else{let N=t.nextStep();t.activate(I,N,void 0,z),l.set(I,N)}else if(W==="deactivate"){let N=!1;s!==-1&&s>(l.get(I)??-1)&&(r==="arrow"?N=I===c||I===a:r==="dotted"&&(N=I===a)),N?t.deactivate(I,s):t.deactivate(I,t.nextStep())}else if(W==="destroy"){let N=!1;s!==-1&&s>(l.get(I)??-1)&&(r==="arrow"?N=I===c||I===a:r==="dotted"&&(N=I===a)),N?t.destroy(I,s):t.destroy(I,t.nextStep())}continue}let x=f.match(/^\{(\w+)\}\s*<->\s*\{(\w+)\}(?:\s*:\s*(.*))?$/);if(x){let[,D,C,z]=x;t.addTimeConstraint(D,C,z||"");continue}let y=f.match(/^\.\.\.(?:\s*(.*?)\s*\.\.\.)?$/);if(y){let[,D]=y;t.addDelay(D||void 0);continue}let M=f.match(/^(?:\{(\w+)\}\s+)?(".*?"|\w+|x|\[|\])?\s*([<ox\\/]*)([-.]+)(?:\[(#\w+)\])?([-.]*)([>ox\\/]*)?\s*(".*?"|\w+|x|\[|\])?\s*(--\+\+|\+\+--|--|\+\+|\*\*|!!)?(?:\s+(#\w+))?(?:\s*:\s*(.*))?$/i);if(M){let[,D,C,z,I,W,N,G,F,Y,H,U]=M;U=U||"";let O=I+(N||"");if(O.length>0){C&&(C=C.replace(/^"(.*)"$/,"$1")),F&&(F=F.replace(/^"(.*)"$/,"$1")),(!C||C==="[")&&(C="["),(!F||F==="]")&&(F="]");let V=O.includes("..")||O.includes("--"),Q=z.includes("<")&&(G||"").includes(">"),K=(q,ut)=>q?q===">"||q==="<"?"default":q===">>"||q==="<<"?"open":q==="\\"||q==="/"?"half":q==="\\\\"||q==="//"?"open":q.includes("x")?"lost":q.includes("o")?"arrow-circle":"default":"none",tt=K(G||"",!1),et=K(z||"",!0);G==="x"&&(tt="lost"),C==="x"&&(et="found");let kt=U.replace(/\\n/g,`
`),B=t.addMessage(C,F,kt,V?"dotted":"arrow",tt,W,Q,et);D&&t.addTaggedStep(D,B);let pt=C,mt=F,nt=q=>["default","open","half","arrow-circle"].includes(q);if(nt(et)&&!nt(tt)?(pt=F,mt=C):nt(tt)&&!nt(et)&&(pt=C,mt=F),s=B,a=pt,c=mt,r=V?"dotted":"arrow",Y==="++"){if(H&&H.startsWith("#")){let q=H.substring(1);/^[0-9A-Fa-f]+$/.test(q)&&[3,4,6,8].includes(q.length)||(H=q)}t.activate(F,B,B,H),l.set(F,B)}else if(Y==="--")t.deactivate(C,B,B);else if(Y==="--++"){if(t.deactivate(C,B,B),H&&H.startsWith("#")){let q=H.substring(1);/^[0-9A-Fa-f]+$/.test(q)&&[3,4,6,8].includes(q.length)||(H=q)}t.activate(F,B,B,H),l.set(F,B)}else if(Y==="++--"){if(H&&H.startsWith("#")){let q=H.substring(1);/^[0-9A-Fa-f]+$/.test(q)&&[3,4,6,8].includes(q.length)||(H=q)}t.activate(C,B,B,H),l.set(C,B),t.deactivate(F,B,B)}else Y==="**"?t.create(F,B):Y==="!!"&&t.destroy(F,B);continue}}let R=f.match(/^(h|r|b)?note\s+(left|right|over|across)(?:\s+(?:of\s+)?([^#:]+))?\s*(#\w+)?\s*(?::\s*(.*))?$/i);if(R){let[,D,C,z,I,W]=R,N=[];z&&z.trim()&&(N=z.split(",").map(F=>F.trim().replace(/^"(.*)"$/,"$1")));let G="folder";if(D==="h"?G="hexagon":D==="r"?G="rectangle":D==="b"&&(G="bubble"),W!==void 0){let F=C.toLowerCase(),Y;if(N.length===0&&(F==="right"||F==="left")&&a&&c){let U=t.participants.findIndex(V=>V.name===a),O=t.participants.findIndex(V=>V.name===c);if(U!==-1&&O!==-1){let V=t.participants[U],Q=t.participants[O],K=U<O;V.order!==void 0&&Q.order!==void 0&&(K=V.order<Q.order),F==="left"?N=[K?a:c]:N=[K?c:a]}else N=[c];s!==-1&&(Y=s)}let H=W.replace(/\\n/g,`
`);t.addNote(H,C.toLowerCase(),N,I,G,Y)}else o={text:[],position:C.toLowerCase(),participants:N,color:I,shape:G};continue}let E=f.match(/^(alt|opt|loop|par|break|critical|group)(?:\s+(.*))?$/i);if(E){let[,D,C]=E;t.startGroup(D.toLowerCase(),C||"");continue}let v=f.match(/^else(?:\s+(.*))?$/i);if(v){let[,D]=v;t.addGroupSection(D||"");continue}if(f.toLowerCase().startsWith("end")){t.endGroup();continue}let A=f.match(/^ref\s+over\s+(.*?)(?:\s*:\s*(.*))?$/i);if(A){let[,D,C]=A,z=D.split(",").map(I=>I.trim().replace(/^"(.*)"$/,"$1"));C?t.addReference(z,C):i={participants:z,label:[]};continue}let m=f.match(/^return(?:\s+(.*))?$/i);if(m){let[,D]=m,C=(D||"").replace(/\\n/g,`
`);t.returnMessage(C);continue}if(/^autonumber\s+stop$/i.test(f)){t.stopAutonumber();continue}let u=f.match(/^autonumber\s+resume(?:\s+(\d+))?(?:\s+"(.*?)"|)$/i);if(u){let[,D,C]=u;t.resumeAutonumber(D?parseInt(D,10):void 0,C);continue}let b=f.match(/^autonumber\s+inc\s+([A-Z])$/i);if(b){t.incrementAutonumberLevel(b[1]);continue}let S=f.match(/^autonumber(?:\s+([\d.]+))?(?:\s+(\d+))?(?:\s+"(.*?)"|)$/i);if(S){let[,D,C,z]=S,I=C?parseInt(C,10):1;t.setAutonumber(D||1,I,z);continue}let k=f.match(/^autoactivate\s+(on|off)$/i);if(k){t.setAutoactivate(k[1].toLowerCase()==="on");continue}let w=f.match(/^==\s*(.*?)\s*==$/);if(w){t.addDivider(w[1]);continue}if(f==="|||"){t.addSpacing();continue}let L=f.match(/^\|\|(\d+)\|\|$/);if(L){t.addSpacing(parseInt(L[1],10));continue}let T=f.match(/^(title|header|footer)\s+(.*)$/i);if(T){let[,D,C]=T;D.toLowerCase()==="title"?t.setTitle(C):D.toLowerCase()==="header"?t.setHeader(C):D.toLowerCase()==="footer"&&t.setFooter(C);continue}if(f.toLowerCase()==="hide footbox"){t.setHideFootbox(!0);continue}let X="(participant|actor|boundary|control|entity|database|collections|queue)",j=new RegExp(`^${X}\\s+(".*?"|\\w+)\\s*(?:<<\\s*(.*?)\\s*>>)?(?:\\s+as\\s+(".*?"|\\w+))?\\s*(?:<<\\s*(.*?)\\s*>>)?(?:\\s+order\\s+(\\d+))?(?:\\s+(#\\w+))?$`,"i"),Z=f.match(j);if(Z){let[,D,C,z,I,W,N,G]=Z;if(!D||!C)continue;let F=z||W,Y,H;I?I.startsWith('"')?(Y=C.replace(/^"(.*)"$/,"$1"),H=I.replace(/^"(.*)"$/,"$1")):(Y=I.replace(/^"(.*)"$/,"$1"),H=C.replace(/^"(.*)"$/,"$1")):(Y=C.replace(/^"(.*)"$/,"$1"),H=void 0);let U=N?parseInt(N,10):void 0;t.addParticipant(Y,H,D.toLowerCase(),U,G,F);continue}if(h.trim()!==""&&!h.trim().startsWith("'"))throw new Error(`Syntax error at line ${d+1}: ${f}`)}return t}};var xt={padding:40,participantWidth:120,participantHeight:40,participantGap:180,defaultMessageGap:50,fontSize:14,activationWidth:12,colors:{defaultStroke:"#333333",defaultFill:"#eeeeee",actorFill:"#f8f9fa",noteFill:"#ffffcc",line:"#666666",text:"#000000"},fontFamily:"sans-serif"};var st=class{constructor(n){this.theme=n}calculateLayout(n){let t=[...n.participants].sort((E,v)=>E.order!==void 0&&v.order!==void 0?E.order-v.order:E.order!==void 0?-1:v.order!==void 0?1:0),e=this.calculateMaxStep(n);this.finalizeEndSteps(n,e);let i=this.calculateStepHeights(n,e),o=i.stepY,s=i.totalHeight,a=t.map(E=>this.calculateParticipantWidth(E)),c=this.calculateGaps(n,t,a),r=this.calculateRelativepCenterXs(t,a,c),l=this.preCalculateNoteLayouts(n,t,r,a,o),d=this.calculateBounds(t,r,a,l,n.messages),f=this.theme.padding-d.minX,h=d.maxX-d.minX+this.theme.padding*2,p=h;if(n.timeConstraints.length>0){let v=50+Math.max(...n.timeConstraints.map(A=>A.label.length),0)*8;p+=v}let $=n.hideFootbox?0:this.theme.participantHeight+20,g=s+$+this.theme.padding,x=t.map((E,v)=>{let A=r[v]+f;return{participant:E,centerX:A,x:A-a[v]/2,y:E.createdStep!==void 0?o[E.createdStep]-this.theme.participantHeight/2:this.theme.padding,width:a[v],height:this.theme.participantHeight,destroyedY:E.destroyedStep!==void 0?o[E.destroyedStep]:void 0}}),y=[];l.forEach((E,v)=>{let A=E.x+f,m=E.width;v.position==="across"&&(A=this.theme.padding,m=Math.max(h-this.theme.padding*2,E.width)),y.push({note:v,x:A,y:E.y,width:m,height:E.height})});let M=this.calculateGroupLayouts(n,x,y,o,e),R=this.calculateActivationLayouts(n,x,o,n.messages);return{width:p,height:g,participants:x,notes:y,dividers:this.calculateDividerLayouts(n,o,p),references:this.calculateReferenceLayouts(n,x,o),messages:this.calculateMessageLayouts(n,x,o,R),groups:M,activations:R,delays:this.calculateDelayLayouts(n,o),timeConstraints:this.calculateTimeConstraintLayouts(n,x,o,h)}}calculateMessageLayouts(n,t,e,i){return n.messages.map(o=>{let s=t.findIndex(h=>h.participant.name===o.from),a=t.findIndex(h=>h.participant.name===o.to),c=e[o.step],r=s!==-1?t[s].centerX:0,l=a!==-1?t[a].centerX:0;if(s!==-1&&a!==-1){let h=i.filter($=>$.activation.participantName===o.from&&$.activation.startStep<=o.step&&($.activation.endStep??1/0)>=o.step).sort(($,g)=>g.activation.level-$.activation.level),p=i.filter($=>$.activation.participantName===o.to&&$.activation.startStep<=o.step&&($.activation.endStep??1/0)>=o.step).sort(($,g)=>g.activation.level-$.activation.level);s!==a&&(s<a?(h.length>0&&(r=h[0].x+h[0].width),p.length>0&&(l=p[0].x)):(h.length>0&&(r=h[0].x),p.length>0&&(l=p[0].x+p[0].width)))}a!==-1&&t[a].participant.createdStep===o.step&&(l=t[a].x);let d=[{x:r,y:c},{x:l,y:c}],f={x:(r+l)/2,y:c};if(s===a&&s!==-1){let h=i.filter(g=>g.activation.participantName===o.from&&g.activation.startStep<=o.step&&(g.activation.endStep??1/0)>=o.step).sort((g,x)=>x.activation.level-g.activation.level),p=0,$=0;if(h.length>0){let g=h[0];g.activation.startStep===o.step?h.length>1?(p=1,$=0):(p=void 0,$=0):g.activation.endStep===o.step&&(h.length>1?(p=0,$=1):(p=0,$=void 0));let x=p!==void 0&&h.length>p?h[p].x+h[p].width:t[s].centerX,y=$!==void 0&&h.length>$?h[$].x+h[$].width:t[s].centerX,M=40;d[0]={x,y:c},d[1]={x:Math.max(x,y)+M,y:c},d.push({x:Math.max(x,y)+M,y:c+25}),d.push({x:y,y:c+25}),f={x:Math.max(x,y)+M+5,y:c+10}}else{let g=t[s].centerX,x=40;d[0]={x:g,y:c},d[1]={x:g+x,y:c},d.push({x:g+x,y:c+25}),d.push({x:g,y:c+25}),f={x:g+x+5,y:c+10}}}return{message:o,y:c,points:d,labelPosition:f,lineStyle:o.type==="dotted"?"dashed":"solid"}})}calculateDividerLayouts(n,t,e){return n.dividers.map(i=>({y:t[i.step],label:i.label}))}calculateDelayLayouts(n,t){return n.delays.map(e=>({y:t[e.step],text:e.text}))}calculateTimeConstraintLayouts(n,t,e,i){return n.timeConstraints.map(o=>{let s=n.taggedSteps.get(o.startTag),a=n.taggedSteps.get(o.endTag);return s===void 0||a===void 0?null:{x:i-this.theme.padding+20,startY:e[s],endY:e[a],label:o.label}}).filter(o=>o!==null)}calculateReferenceLayouts(n,t,e){return n.references.map(i=>{let o=i.participants.map(f=>t.findIndex(h=>h.participant.name===f)).filter(f=>f!==-1);if(o.length===0)return null;let s=Math.min(...o),a=Math.max(...o),c=t[s].x,r=t[a].x+t[a].width-c,l=e[i.startStep]-10,d=e[i.endStep]-l;return{reference:i,x:c,y:l,width:r,height:d}}).filter(i=>i!==null)}calculateActivationLayouts(n,t,e,i){return n.activations.map(o=>{let s=t.findIndex(h=>h.participant.name===o.participantName);if(s===-1)return null;let c=t[s].centerX-this.theme.activationWidth/2+o.level*5,r=e[o.startStep];if(o.sourceStep!==void 0){let h=i.find(p=>p.step===o.sourceStep);h&&h.from===o.participantName&&h.to===o.participantName&&(r+=25)}let l=e[o.endStep];if(o.endSourceStep!==void 0){let h=i.find(p=>p.step===o.endSourceStep);h&&h.from===o.participantName&&h.to===o.participantName&&(l+=25)}let f=Math.max(5,l-r);return{activation:o,x:c,y:r,width:this.theme.activationWidth,height:f}}).filter(o=>o!==null)}calculateMaxStep(n){let t=0;return[...n.messages,...n.activations,...n.groups,...n.references,...n.notes,...n.dividers,...n.delays,...n.spacings].forEach(i=>{let o=i.step??i.startStep??i.endStep??0;o>t&&(t=o)}),t+1}finalizeEndSteps(n,t){n.activations.forEach(e=>{e.endStep===void 0&&(e.endStep=t)}),n.groups.forEach(e=>{e.endStep===void 0&&(e.endStep=t)})}calculateStepHeights(n,t){let e=new Array(t+1).fill(this.theme.defaultMessageGap),i=new Array(t+2).fill(0),o=new Array(t+2).fill(0);n.notes.forEach(r=>{let d=r.text.split(`
`).length*20+10;i[r.step]=Math.max(i[r.step],d/2),o[r.step]=Math.max(o[r.step],d/2)}),n.messages.forEach(r=>{let d=r.text.split(`
`).length;if(r.from===r.to){let f=Math.max(25,d*20);i[r.step]=Math.max(i[r.step],0),o[r.step]=Math.max(o[r.step],f+10)}else{let f=d*15+5;i[r.step]=Math.max(i[r.step],f),o[r.step]=Math.max(o[r.step],0)}});let s=new Array(t+1).fill(this.theme.defaultMessageGap);n.dividers.forEach(r=>{s[r.step]=30}),n.delays.forEach(r=>{s[r.step]=40}),n.spacings.forEach(r=>{s[r.step]=r.height}),n.references.forEach(r=>{let d=r.label.split(`
`).length*15+40;r.endStep===r.startStep+1&&(s[r.startStep]=Math.max(s[r.startStep],d))});for(let r=0;r<=t;r++){let l=o[r]+i[r+1]+10;e[r]=Math.max(s[r],l)}let a=new Array(t+1).fill(0),c=this.theme.padding+90;for(let r=0;r<=t;r++)a[r]=c,c+=e[r];return{stepY:a,totalHeight:c}}calculateParticipantWidth(n){let e=(n.label||n.name).replace(/\\n/g,`
`).split(`
`),i=Math.max(...e.map(o=>o.length));return Math.max(this.theme.participantWidth,i*9+30)}calculateGaps(n,t,e){let i=Math.max(0,t.length-1),o=new Array(i).fill(60),s=this.calculateMaxStep(n);for(let a=0;a<=s;a++){let c=new Array(i).fill(0);for(let r=0;r<t.length;r++){let l=t[r].name;if(t[r].createdStep===a){let y=e[r];r<i&&(c[r]=Math.max(c[r],y/2+20))}let f=15,h=n.messages.find(y=>y.step===a&&y.from===l&&y.to===l);h&&(f=40+(Math.max(...h.text.split(`
`).map(M=>M.length*8))+20)+10);let p=n.activations.filter(y=>y.participantName===l&&y.startStep<=a&&(y.endStep??1/0)>=a);if(p.length>0){let y=Math.max(...p.map(M=>M.level));f=Math.max(f,this.theme.activationWidth/2+y*5+10)}n.notes.filter(y=>y.step===a&&y.position==="right"&&y.participants?.includes(l)).forEach(y=>{let M=Math.max(60,Math.max(...y.text.split(`
`).map(R=>R.length*8.5))+20);f+=M+10}),r<i&&(c[r]+=f);let g=15;n.notes.filter(y=>y.step===a&&y.position==="left"&&y.participants?.includes(l)).forEach(y=>{let M=Math.max(60,Math.max(...y.text.split(`
`).map(R=>R.length*8.5))+20);g+=M+10}),r>0&&(c[r-1]+=g)}for(let r=0;r<i;r++)o[r]=Math.max(o[r],c[r])}return n.messages.forEach(a=>{let c=t.findIndex(p=>p.name===a.from),r=t.findIndex(p=>p.name===a.to);if(c===-1||r===-1||c===r)return;let l=Math.max(...a.text.split(`
`).map(p=>p.length*8))+20,d=Math.min(c,r),f=Math.max(c,r),h=0;for(let p=d;p<f;p++)h+=e[p]/2+o[p]+e[p+1]/2;if(h<l){let $=(l-h)/(f-d);for(let g=d;g<f;g++)o[g]+=$}}),n.notes.forEach(a=>{if(a.position!=="over"&&a.position!=="across")return;let c=a.text.split(`
`),r=Math.max(60,Math.max(...c.map(l=>l.length*8.5))+20);if(a.participants&&a.participants.length>0){let l=t.findIndex(p=>p.name===a.participants[0]),d=a.participants.length>1?t.findIndex(p=>p.name===a.participants[1]):l;if(l===-1||d===-1)return;let f=Math.min(l,d),h=Math.max(l,d);if(f===h){let p=r/2+10;f<i&&o[f]<p&&(o[f]=p)}else{let p=0;for(let $=f;$<h;$++)p+=e[$]/2+o[$]+e[$+1]/2;if(p<r){let g=(r-p)/(h-f);for(let x=f;x<h;x++)o[x]+=g}}}}),o}calculateRelativepCenterXs(n,t,e){let i=new Array(n.length).fill(0);return n.forEach((o,s)=>{s===0?i[s]=t[s]/2:i[s]=i[s-1]+t[s-1]/2+e[s-1]+t[s]/2}),i}preCalculateNoteLayouts(n,t,e,i,o){let s=new Map,a=new Map;return n.notes.forEach(c=>{let r=c.text.split(`
`),l=Math.max(...r.map(g=>g.length*8.5))+20,f=Math.max(l,60),h=r.length*20+10,p=o[c.step]-h/2,$=0;if(c.position==="across")$=0,s.set(c,{x:$,y:p,width:f,height:h});else if(c.position==="over"){let g=c.participants.map(x=>t.findIndex(y=>y.name===x)).filter(x=>x!==-1);if(g.length>0){let x=Math.min(...g),y=Math.max(...g),M=e[y]+i[y]/2-(e[x]-i[x]/2),R=Math.max(M,f);$=e[x]-i[x]/2-(R-M)/2,s.set(c,{x:$,y:p,width:R,height:h})}}else{let g=(c.participants||[]).map(x=>t.findIndex(y=>y.name===x)).filter(x=>x!==-1);if(g.length>0){let x=c.position==="left"?Math.min(...g):Math.max(...g),y=e[x],M=`${c.step}-${x}-${c.position}`,R=t[x],E=i[x]/2,A=c.step===R.createdStep?E:0;if(c.position==="left")$=(a.get(M)??y-A-5)-f,a.set(M,$-10);else{let m=n.messages.find(T=>T.step===c.step&&T.from===R.name&&T.to===R.name),u=0;if(m){let T=m.text.split(`
`);u=40+(Math.max(...T.map(j=>j.length*8))+20)}let b=n.activations.filter(T=>T.participantName===R.name&&T.startStep<=c.step&&(T.endStep??1/0)>=c.step),S=b.length>0?Math.max(...b.map(T=>T.level)):0,k=this.theme.activationWidth/2+S*5,w=Math.max(A,k,u);$=a.get(M)??y+w+5,a.set(M,$+f+10)}s.set(c,{x:$,y:p,width:f,height:h})}}}),s}calculateBounds(n,t,e,i,o){let s=0,a=0;return n.forEach((c,r)=>{let l=t[r]-e[r]/2,d=t[r]+e[r]/2;r===0?(s=l,a=d):(l<s&&(s=l),d>a&&(a=d))}),i.forEach(c=>{c.x<s&&(s=c.x),c.x+c.width>a&&(a=c.x+c.width)}),o.forEach(c=>{let r=n.findIndex(h=>h.name===c.from),l=n.findIndex(h=>h.name===c.to);if(r===-1||l===-1)return;let d=c.text.split(`
`),f=Math.max(...d.map(h=>h.length*8))+20;if(r===l){let h=t[r],p=Math.max(...c.text.split(`
`).map(g=>g.length*8))+20,$=h+40+p+10;$>a&&(a=$)}else{let h=t[r],p=t[l],$=(h+p)/2,g=$-f/2,x=$+f/2;g<s&&(s=g),x>a&&(a=x)}}),{minX:s,maxX:a}}calculateGroupLayouts(n,t,e,i,o){let s=n.groups.length>0?Math.max(...n.groups.map(a=>a.level)):0;return n.groups.map(a=>{let c=a.participants.map(v=>t.findIndex(A=>A.participant.name===v)).filter(v=>v!==-1);if(c.length===0)return null;let r=Math.min(...c),l=Math.max(...c),d=s-a.level,f=10+d*10,h=25+d*8,p=5+d*8,$=t[r].x+t[r].width/2-t[r].width/2-f,g=t[r].x-f,x=t[l].x+t[l].width+f-g;e.filter(v=>{let A=v.note;if(A.step<a.startStep||A.step>(a.endStep||o))return!1;let m=A.owner;if(!m)return!1;if(m===a)return!0;let u=m.endStep??o,b=a.endStep??o;return m.startStep>=a.startStep&&u<=b}).forEach(v=>{let A=v.note;if(A.position==="right"){let m=(A.participants||[]).map(u=>t.findIndex(b=>b.participant.name===u)).filter(u=>u!==-1);if(m.length>0&&Math.max(...m)===l){let u=v.x+v.width,b=g+x;u+10>b&&(x=u+10-g)}}else if(A.position==="left"){let m=(A.participants||[]).map(u=>t.findIndex(b=>b.participant.name===u)).filter(u=>u!==-1);if(m.length>0&&Math.min(...m)===r){let u=v.x,b=g;if(u-10<b){let S=b-(u-10);g-=S,x+=S}}}});let M=i[a.startStep]-h,R=i[a.endStep]+p,E=a.sections.map(v=>({label:v.label,y:i[v.startStep]}));return{group:a,x:g,y:M,width:x,height:R-M,type:a.type,label:a.label,sections:E}}).filter(a=>a!==null)}};var rt=class{constructor(){this.theme=xt;this.lastSvg="";this.layoutEngine=new st(this.theme)}render(n){this.ensureParticipants(n);let t=this.layoutEngine.calculateLayout(n);return this.generateSvg(n,t)}ensureParticipants(n){n.notes.forEach(t=>{t.participants&&t.participants.forEach(e=>n.addParticipant(e))})}generateSvg(n,t){let e=`<svg width="${t.width}" height="${t.height}" viewBox="0 0 ${t.width} ${t.height}" xmlns="http://www.w3.org/2000/svg" style="background: white; font-family: ${this.theme.fontFamily};">`;return e+=this.renderDefs(n),e+=this.renderLifelines(n,t),e+=this.renderActivations(n,t),e+=this.renderGroups(t),e+=this.renderParticipants(n,t),e+=this.renderReferences(n,t),e+=this.renderNotes(t),e+=this.renderMessages(n,t),e+=this.renderDividers(n,t),e+=this.renderDelays(n,t),e+=this.renderTimeConstraints(t),e+=this.renderDestructionMarks(t),n.title&&(e+=`<text x="${t.width/2}" y="25" text-anchor="middle" font-size="${this.theme.fontSize+4}" font-weight="bold">${n.title}</text>`),n.header&&(e+=`<text x="${t.width-this.theme.padding}" y="15" text-anchor="end" font-size="${this.theme.fontSize-4}">${n.header}</text>`),n.footer&&(e+=`<text x="${t.width/2}" y="${t.height-10}" text-anchor="middle" font-size="${this.theme.fontSize-4}">${n.footer}</text>`),e+="</svg>",e}renderDefs(n){let t=new Set;t.add(this.theme.colors.defaultStroke),n.messages.forEach(i=>{t.add(this.normalizeColor(i.color,this.theme.colors.defaultStroke))});let e="<defs>";return t.forEach(i=>{let o=i.replace("#","");e+=`
      <marker id="arrowhead-${o}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="${i}" />
      </marker>
      <marker id="arrowhead-reverse-${o}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="10 0, 0 3.5, 10 7" fill="${i}" />
      </marker>
      <marker id="arrowhead-open-${o}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <path d="M 0 0 L 10 3.5 L 0 7" fill="none" stroke="${i}" stroke-width="1" />
      </marker>
      <marker id="arrowhead-open-reverse-${o}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <path d="M 10 0 L 0 3.5 L 10 7" fill="none" stroke="${i}" stroke-width="1" />
      </marker>
      <marker id="halfhead-${o}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 3.5" fill="${i}" />
      </marker>
      <marker id="halfhead-reverse-${o}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="10 0, 0 3.5, 10 3.5" fill="${i}" />
      </marker>
      <marker id="circlehead-${o}" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
        <circle cx="4" cy="4" r="3" fill="white" stroke="${i}" stroke-width="1.5" />
      </marker>
      <marker id="arrowhead-circle-${o}" markerWidth="18" markerHeight="7.5" refX="14" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="${i}" />
        <circle cx="14" cy="3.5" r="3" fill="${i}" stroke="${i}" stroke-width="1" />
      </marker>
      <marker id="arrowhead-circle-reverse-${o}" markerWidth="18" markerHeight="7.5" refX="4" refY="3.5" orient="auto">
        <polygon points="17 0, 7 3.5, 17 7" fill="${i}" />
        <circle cx="4" cy="3.5" r="3" fill="${i}" stroke="${i}" stroke-width="1" />
      </marker>
      <marker id="losthead-${o}" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
        <line x1="0" y1="0" x2="10" y2="10" stroke="${i}" stroke-width="2" />
        <line x1="10" y1="0" x2="0" y2="10" stroke="${i}" stroke-width="2" />
      </marker>`}),e+="</defs>",e}renderLifelines(n,t){let e="";return t.participants.forEach(i=>{if(i.participant.name==="["||i.participant.name==="]")return;let o=i.centerX,s=i.destroyedY!==void 0?i.destroyedY:n.hideFootbox?t.height-this.theme.padding:t.height-this.theme.padding-this.theme.participantHeight;e+=`<line x1="${o}" y1="${i.y+i.height}" x2="${o}" y2="${s}" stroke="${this.theme.colors.line}" stroke-dasharray="4" />`}),e}renderDestructionMarks(n){let t="";return n.participants.forEach(e=>{if(e.destroyedY!==void 0){let i=e.centerX,o=e.destroyedY,s=12;t+=`<line x1="${i-s}" y1="${o-s}" x2="${i+s}" y2="${o+s}" stroke="#FF0000" stroke-width="3" />`,t+=`<line x1="${i+s}" y1="${o-s}" x2="${i-s}" y2="${o+s}" stroke="#FF0000" stroke-width="3" />`}}),t}renderParticipants(n,t){let e="",i=(o,s)=>{let a=this.normalizeColor(o.participant.color,this.theme.colors.actorFill),c=o.x,r=s?o.y:t.height-this.theme.padding-this.theme.participantHeight-20,l=o.centerX,d=r+this.theme.participantHeight/2,h=(o.participant.label||o.participant.name).replace(/\\n/g,`
`).split(`
`);switch(o.participant.type){case"actor":e+=`<circle cx="${l}" cy="${r+10}" r="8" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${l}" y1="${r+18}" x2="${l}" y2="${r+30}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${l-10}" y1="${r+22}" x2="${l+10}" y2="${r+22}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${l}" y1="${r+30}" x2="${l-8}" y2="${r+40}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${l}" y1="${r+30}" x2="${l+8}" y2="${r+40}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((k,w)=>{e+=`<text x="${l}" y="${r+55+w*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;case"boundary":e+=`<line x1="${l-20}" y1="${d}" x2="${l-10}" y2="${d}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${l-20}" y1="${d-10}" x2="${l-20}" y2="${d+10}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<circle cx="${l}" cy="${d}" r="14" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((k,w)=>{e+=`<text x="${l}" y="${r+this.theme.participantHeight+20+w*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;case"control":e+=`<circle cx="${l}" cy="${d}" r="14" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${l+4} ${d-18} L ${l-4} ${d-14} L ${l+4} ${d-10}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((k,w)=>{e+=`<text x="${l}" y="${r+this.theme.participantHeight+20+w*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;case"entity":e+=`<circle cx="${l}" cy="${d}" r="14" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${l-14}" y1="${d+14}" x2="${l+14}" y2="${d+14}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((k,w)=>{e+=`<text x="${l}" y="${r+this.theme.participantHeight+20+w*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;case"database":let p=34,$=40,g=r,x=l-p/2;e+=`<path d="M ${x} ${g+10} L ${x} ${g+$-10} A 17 8 0 0 0 ${x+p} ${g+$-10} L ${x+p} ${g+10} A 17 8 0 0 0 ${x} ${g+10} M ${x} ${g+10} A 17 8 0 0 1 ${x+p} ${g+10}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${x} ${g+10} A 17 8 0 0 0 ${x+p} ${g+10}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((k,w)=>{e+=`<text x="${l}" y="${r+this.theme.participantHeight+20+w*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;case"collections":let y=34,M=34,R=r+3,E=l-y/2;e+=`<rect x="${E+4}" y="${R-4}" width="${y}" height="${M}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<rect x="${E}" y="${R}" width="${y}" height="${M}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((k,w)=>{e+=`<text x="${l}" y="${r+this.theme.participantHeight+20+w*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;case"queue":let v=40,A=40,m=r+3,u=l-v/2,b=5,S=A/2;e+=`<path d="M ${u+v} ${m} L ${u} ${m} A ${b} ${S} 0 0 0 ${u} ${m+A} L ${u+v} ${m+A} A ${b} ${S} 0 0 0 ${u+v} ${m}" fill="${a}" stroke="none" />`,e+=`<ellipse cx="${u+v}" cy="${m+S}" rx="${b}" ry="${S}" fill="${a}" stroke="none" />`,e+=`<path d="M ${u+v} ${m} L ${u} ${m} A ${b} ${S} 0 0 0 ${u} ${m+A} L ${u+v} ${m+A}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<ellipse cx="${u+v}" cy="${m+S}" rx="${b}" ry="${S}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((k,w)=>{e+=`<text x="${l}" y="${r+this.theme.participantHeight+20+w*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`});break;default:e+=`<rect x="${c}" y="${r}" width="${o.width}" height="${this.theme.participantHeight}" rx="5" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,h.forEach((k,w)=>{let L=h.length>1?d-(h.length-1)*7.5+w*15:d;e+=`<text x="${l}" y="${L}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}" font-weight="bold">${k}</text>`})}};return t.participants.forEach(o=>{o.participant.name==="["||o.participant.name==="]"||(i(o,!0),n.hideFootbox||i(o,!1))}),e}renderGroups(n){let t="";return n.groups.forEach(e=>{t+=`<rect x="${e.x}" y="${e.y}" width="${e.width}" height="${e.height}" fill="none" stroke="#222" stroke-width="2" rx="5" />`,t+=`<path d="M ${e.x} ${e.y} L ${e.x+70} ${e.y} L ${e.x+70} ${e.y+10} L ${e.x+60} ${e.y+20} L ${e.x} ${e.y+20} Z" fill="#eee" stroke="#222" stroke-width="2" />`,t+=`<text x="${e.x+5}" y="${e.y+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">${e.type}</text>`,e.label&&(t+=`<text x="${e.x+75}" y="${e.y+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">[${e.label}]</text>`),e.sections.forEach(i=>{let o=i.y;t+=`<line x1="${e.x}" y1="${o}" x2="${e.x+e.width}" y2="${o}" stroke="#222" stroke-width="1" stroke-dasharray="5,5" />`,t+=`<text x="${e.x+5}" y="${o+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">[${i.label}]</text>`})}),t}renderNotes(n){let t="";return n.notes.forEach(e=>{this.drawNoteShape(t,e.x,e.y,e.width,e.height,e.note.shape,e.note.color,e.note.text),t=this.lastSvg}),t}renderActivations(n,t){let e="";return[...t.activations].sort((o,s)=>o.activation.level-s.activation.level).forEach(o=>{let s=o.activation.color||this.theme.colors.actorFill;e+=`<rect x="${o.x}" y="${o.y}" width="${o.width}" height="${o.height}" fill="${s}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`}),e}renderReferences(n,t){let e="";return t.references.forEach(i=>{e+=`<rect x="${i.x}" y="${i.y}" width="${i.width}" height="${i.height}" fill="${this.theme.colors.defaultFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${i.x} ${i.y} L ${i.x+70} ${i.y} L ${i.x+70} ${i.y+10} L ${i.x+60} ${i.y+20} L ${i.x} ${i.y+20} Z" fill="#eee" stroke="#222" stroke-width="2" />`,e+=`<text x="${i.x+5}" y="${i.y+12}" font-size="${this.theme.fontSize-2}" font-weight="bold">ref</text>`;let o=i.reference.label.split(`
`),s=this.theme.fontSize+2,a=o.length*s,c=25,r=i.y+i.height/2-a/2+s/2;r<i.y+c+s/2&&(r=i.y+c+s/2),o.forEach((l,d)=>{e+=`<text x="${i.x+i.width/2}" y="${r+d*s}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}">${l}</text>`})}),e}renderMessages(n,t){let e="";return t.messages.forEach(i=>{let o=i.message,s=this.normalizeColor(o.color,this.theme.colors.defaultStroke),a=i.lineStyle==="dashed"?"4":"0",c=s.replace("#",""),r=(g,x)=>{if(g==="none")return"none";let y="";return g==="default"?y=x?`arrowhead-reverse-${c}`:`arrowhead-${c}`:g==="open"?y=x?`arrowhead-open-reverse-${c}`:`arrowhead-open-${c}`:g==="half"?y=x?`halfhead-reverse-${c}`:`halfhead-${c}`:g==="circle"?y=`circlehead-${c}`:g==="arrow-circle"?y=x?`arrowhead-circle-reverse-${c}`:`arrowhead-circle-${c}`:g==="lost"?y=`losthead-${c}`:g==="found"&&(y=`circlehead-${c}`),y?`url(#${y})`:"none"},l=r(o.arrowHead||"default",!1),d=r(o.startHead||(o.bidirectional?"default":"none"),!0);if(i.points.length>2){let g=`M ${i.points.map(x=>`${x.x} ${x.y}`).join(" L ")}`;e+=`<path d="${g}" fill="none" stroke="${s}" stroke-width="1.5" stroke-dasharray="${a}" marker-end="${l}" marker-start="${d}" />`}else{let[g,x]=i.points;e+=`<line x1="${g.x}" y1="${g.y}" x2="${x.x}" y2="${x.y}" stroke="${s}" stroke-width="1.5" stroke-dasharray="${a}" marker-end="${l}" marker-start="${d}" />`}let f=o.number?this.formatRichText(o.number):"",p=(o.text||"").split(`
`),$=i.points.length>2?"start":"middle";p.forEach((g,x)=>{let M=i.labelPosition.y-(p.length-1-x)*15-5;i.points.length>2&&(M=i.labelPosition.y+x*20);let R=this.formatRichText(g),E=x===0&&f?`${f} ${R}`:R;e+=`<text x="${i.labelPosition.x}" y="${M}" text-anchor="${$}" font-size="${this.theme.fontSize-2}" fill="${s}">${E}</text>`})}),e}renderDividers(n,t){let e="";return t.dividers.forEach(i=>{let o=i.y;if(e+=`<line x1="${this.theme.padding}" y1="${o}" x2="${t.width-this.theme.padding}" y2="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,e+=`<line x1="${this.theme.padding}" y1="${o+4}" x2="${t.width-this.theme.padding}" y2="${o+4}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,i.label){let s=i.label.length*9+20;e+=`<rect x="${t.width/2-s/2}" y="${o-10}" width="${s}" height="20" fill="white" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,e+=`<text x="${t.width/2}" y="${o}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize-2}" font-weight="bold">${i.label}</text>`}}),e}renderDelays(n,t){let e="";return t.delays.forEach(i=>{let o=i.y,s=t.width/2,a=10,c=5;if(i.text){let r=i.text.length*8+20;e+=`<text x="${s}" y="${o}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}" fill="${this.theme.colors.text}">${i.text}</text>`;for(let l=0;l<c;l++){let d=s-r/2-10-l*a;e+=`<circle cx="${d}" cy="${o}" r="1.5" fill="${this.theme.colors.text}" />`}for(let l=0;l<c;l++){let d=s+r/2+10+l*a;e+=`<circle cx="${d}" cy="${o}" r="1.5" fill="${this.theme.colors.text}" />`}}else for(let r=-10;r<=10;r++)r!==0&&(e+=`<circle cx="${s+r*a}" cy="${o}" r="1.5" fill="${this.theme.colors.text}" />`)}),e}renderTimeConstraints(n){let t="";return n.timeConstraints.forEach(e=>{let i=e.x,o=e.startY,s=e.endY,a=this.theme.colors.defaultStroke;if(t+=`<line x1="${i}" y1="${o}" x2="${i}" y2="${s}" stroke="${a}" stroke-width="1.5" />`,t+=`<polygon points="${i} ${o}, ${i-4} ${o+8}, ${i+4} ${o+8}" fill="${a}" />`,t+=`<polygon points="${i} ${s}, ${i-4} ${s-8}, ${i+4} ${s-8}" fill="${a}" />`,e.label){let c=(o+s)/2;t+=`<text x="${i+10}" y="${c}" text-anchor="start" dominant-baseline="middle" font-size="${this.theme.fontSize-2}" fill="${a}">${e.label}</text>`}}),t}normalizeColor(n,t){return n?n.startsWith("#")?/^#[0-9a-fA-F]{3,8}$/.test(n)?n:n.substring(1):n:t}formatRichText(n){return _(n)}drawNoteShape(n,t,e,i,o,s,a,c){let r="",l=this.normalizeColor(a,this.theme.colors.noteFill),d=this.theme.colors.defaultStroke,f=s||"folder";if(f==="hexagon"){let $=[`${t+10},${e}`,`${t+i-10},${e}`,`${t+i},${e+o/2}`,`${t+i-10},${e+o}`,`${t+10},${e+o}`,`${t},${e+o/2}`].join(" ");r+=`<polygon points="${$}" fill="${l}" stroke="${d}" stroke-width="1.5" />`}else if(f==="bubble"){let p=o/2;r+=`<rect x="${t}" y="${e}" width="${i}" height="${o}" rx="${p}" ry="${p}" fill="${l}" stroke="${d}" stroke-width="1.5" />`}else if(f==="rectangle")r+=`<rect x="${t}" y="${e}" width="${i}" height="${o}" fill="${l}" stroke="${d}" stroke-width="1.5" />`;else{let $=`
                M ${t} ${e}
                L ${t+i-10} ${e}
                L ${t+i} ${e+10}
                L ${t+i} ${e+o}
                L ${t} ${e+o}
                Z
            `;r+=`<path d="${$}" fill="${l}" stroke="${d}" stroke-width="1.5" />`;let g=`
                M ${t+i-10} ${e}
                L ${t+i-10} ${e+10}
                L ${t+i} ${e+10}
            `;r+=`<path d="${g}" fill="none" stroke="${d}" stroke-width="1.5" />`}c.split(`
`).forEach((p,$)=>{r+=`<text x="${t+i/2}" y="${e+20+$*20}" text-anchor="middle" font-size="${this.theme.fontSize}" fill="${this.theme.colors.text}">${this.formatRichText(p)}</text>`}),this.lastSvg=n+r}};var at=class{constructor(){this.type="component";this.components=[];this.relationships=[];this.notes=[]}addComponent(n,t,e,i,o){let s=this.components.find(a=>a.name===n);return s?(e&&(s.label=e),i&&(s.parentId=i),o&&(s.color=o),t!=="component"&&s.type==="component"&&(s.type=t)):(s={name:n,type:t,label:e||n,isVisible:!0,parentId:i,color:o,declarationOrder:this.components.length},this.components.push(s)),s}addRelationship(n,t,e="solid",i,o,s=!0,a){this.relationships.push({from:n,to:t,type:e,label:i,direction:o,showArrowHead:s})}addNote(n,t,e,i){let o=`note_${this.notes.length}`;this.notes.push({text:n,position:t,linkedTo:e,id:o,alias:i})}findComponent(n){return this.components.find(t=>t.name===n||t.alias===n)}};var ct=class{parse(n){let t=new at,e=n.split(`
`),i=new Set,o=new Set;for(let c=0;c<e.length;c++){let r=e[c].trim();if(!r||r.startsWith("'")||r.startsWith("@"))continue;let l=r.match(/^component\s+(?:\[(.*?)\]|(".*?"|\S+))(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(l){i.add(l[3]||l[1]||(l[2]?l[2].replace(/^"(.*)"$/,"$1"):""));continue}let d=r.match(/^interface\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(d){i.add(d[2]||d[1].replace(/^"(.*)"$/,"$1"));continue}let f=r.match(/^\(\)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(f){i.add(f[2]||f[1].replace(/^"(.*)"$/,"$1"));continue}let h=r.match(/^\[([^\]]+)\](?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(h){i.add(h[2]||h[1]);continue}let p=r.match(/^(port|portin|portout)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?$/i);if(p){i.add(p[3]||p[2].replace(/^"(.*)"$/,"$1"));continue}let $=r.match(/^note\s+as\s+(\S+)$/i);if($){o.add($[1]);continue}}let s=null,a=[];for(let c=0;c<e.length;c++){let r=e[c].trim();if(!r||r.startsWith("'")||r.startsWith("@"))continue;if(s){if(r.endsWith("]"))if(s.isDescription&&s.linkedTo){let u=s.text.join(`
`),b=t.findComponent(s.linkedTo);b&&(b.label=u),s=null}else r.toLowerCase()==="end note"?(t.addNote(s.text.join(`
`),s.position,s.linkedTo,s.alias),s=null):s.text.push(r);else if(r.toLowerCase()==="end note"&&!s.isDescription)t.addNote(s.text.join(`
`),s.position,s.linkedTo,s.alias),s=null;else if(s.isDescription&&r.endsWith("]")){let u=r.substring(0,r.length-1).trim();u&&s.text.push(u);let b=s.text.join(`
`),S=t.findComponent(s.linkedTo);S&&(S.label=b),s=null}else s.text.push(r);continue}let l=a.length>0?a[a.length-1]:void 0,d=r.match(/^\[([^\]]+)\]\s+(left\s+of|right\s+of|top\s+of|bottom\s+of)\s+\[([^\]]+)\](?:\s+(#\w+))?$/i);if(d){let u=d[1],b=d[2].toLowerCase().replace(/\s+of$/,""),S=d[3],k=d[4],w;b==="left"?w="left":b==="right"?w="right":b==="top"?w="top":w="bottom";let L=t.addComponent(u,"component",u,l,this.parseColor(k));L.positionHint={reference:S,position:w};continue}let f=r.match(/^component\s+(?:\[(.*?)\]|(".*?"|\S+))(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(f){let u=f[1],b=f[2],S=f[3],k=f[4],w=u||(b?b.replace(/^"(.*)"$/,"$1"):""),L=S||w;t.addComponent(L,"component",w,l,this.parseColor(k)),r.trim().endsWith("[")&&(s={text:[],linkedTo:L,alias:void 0,isDescription:!0});continue}let h=r.match(/^interface\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(h){let u=h[1].replace(/^"(.*)"$/,"$1"),b=h[2],S=h[3];t.addComponent(b||u,"interface",u,l,this.parseColor(S)),r.trim().endsWith("[")&&(s={text:[],linkedTo:b||u,alias:void 0,isDescription:!0});continue}let p=r.match(/^\(\)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(p){let u=p[1].replace(/^"(.*)"$/,"$1"),b=p[2],S=p[3];t.addComponent(b||u,"interface",u,l,this.parseColor(S));continue}let $=r.match(/^\[([^\]]+)\](?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if($){let u=$[1],b=$[2],S=$[3],k=b||u;t.addComponent(k,"component",u,l,this.parseColor(S)),r.trim().endsWith("[")&&(s={text:[],linkedTo:k,alias:void 0,isDescription:!0});continue}let g=r.match(/^(package|node|folder|frame|cloud|database|component|interface)(?:\s+(".*?"|\S+))?\s*\{$/i);if(g){let u=g[1].toLowerCase(),b=g[2],S=b?b.replace(/^"(.*)"$/,"$1"):u;if(b)t.addComponent(S,u,S,l);else{let k=t.components.filter(w=>w.type===u).length;S=`${u}_${k}_${c}`,t.addComponent(S,u,"",l)}a.push(S);continue}if(r==="}"){a.pop();continue}let x=r.match(/^(port|portin|portout)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?$/i);if(x){let u=x[1].toLowerCase(),b=x[2].replace(/^"(.*)"$/,"$1"),S=x[3],k="port";u==="portin"&&(k="portin"),u==="portout"&&(k="portout"),t.addComponent(S||b,k,b,l);continue}let y='(\\(\\)\\s+)?(?:\\[([^\\]]+)\\]|(".*?"|[^\\s-]+))',M="([<>]*[-.]+[<>]*[^[\\]\\s]*)",R="(?:\\s+|(?<=[^\\s])(?=[<\\-.>])|(?<=[<\\-.>])(?=[^\\s]))",E=new RegExp(`^${y}${R}${M}${R}${y}(?:\\s*:\\s*(.*))?$`),v=r.match(E);if(v){let u=!!v[1],b=v[2]||v[3],S=!!v[2],k=v[4],w=!!v[5],L=v[6]||v[7],T=!!v[6],X=v[8],j=b,Z=L,D=S,C=T,z=u,I=w,W=k.includes("<"),N=k.includes(">");W&&!N&&(j=L,Z=b,D=T,C=S,z=w,I=u);let G=j.replace(/^"(.*)"$/,"$1"),F=Z.replace(/^"(.*)"$/,"$1");if(!t.components.some(O=>O.name===G)&&!o.has(G)){let O=D?"component":"interface";t.addComponent(G,O,G,l)}if(!t.components.some(O=>O.name===F)&&!o.has(F)){let O=C?"component":"interface";t.addComponent(F,O,F,l)}let Y="solid";k.includes("..")?Y="dashed":k.includes("--")&&(Y="solid");let H;if(k.includes("left")||k.includes("le")?H="left":k.includes("right")||k.includes("ri")?H="right":k.includes("up")?H="up":(k.includes("down")||k.includes("do"))&&(H="down"),!H){let V=k.replace(/[<>]/g,"").match(/(-+|\.+)/);if(V){let Q=V[1].length;W&&!N?H=Q>=2?"up":"left":H=Q>=2?"down":"right"}}let U=N||W;t.addRelationship(G,F,Y,X,H,U,l);continue}let A=r.match(/^note\s+as\s+(\S+)$/i);if(A){let u=A[1];s={text:[],alias:u};continue}let m=r.match(/^note\s+(left|right|top|bottom)\s+of\s+(?:\[(.*?)\]|(".*?"|\S+))(?:\s*:\s*(.*))?$/i);if(m){let u=m[1].toLowerCase(),S=(m[2]||m[3]).replace(/^"(.*)"$/,"$1"),k=!!m[2];t.findComponent(S)||t.addComponent(S,k?"component":"interface");let w=m[4];w?t.addNote(w,u,S):s={text:[],position:u,linkedTo:S};continue}}return t}parseColor(n){if(n){if(n.startsWith("#")){let t=n.substring(1);return/^([0-9a-fA-F]{3}|[0-9a-fA-F]{4}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/.test(t)?n:t}return n}}};var lt=class{constructor(n,t){this.diagram=n;this.theme=t;this.layoutMap=new Map;this.gridCells=new Map;this.noteLayoutMap=new Map}calculateLayout(){this.layoutMap.clear();let n=this.diagram.components.filter(h=>!h.parentId);this.layoutGroup(n,0,0);let t=[];this.layoutMap.forEach((h,p)=>{let $=this.diagram.components.find(g=>g.name===p);$&&t.push({...h,component:$})}),this.straightenVerticalLines(t),t.forEach(h=>{let p=this.layoutMap.get(h.component.name);p&&(h.x=p.x,h.y=p.y)});let e=1/0,i=1/0,o=-1/0,s=-1/0;t.forEach(h=>{e=Math.min(e,h.x),i=Math.min(i,h.y),o=Math.max(o,h.x+h.width),s=Math.max(s,h.y+h.height)});let a=this.layoutNotes(t);a.forEach(h=>{e=Math.min(e,h.x),i=Math.min(i,h.y),o=Math.max(o,h.x+h.width),s=Math.max(s,h.y+h.height)});let c=this.theme.padding-e,r=this.theme.padding-i;(c!==0||r!==0)&&(t.forEach(h=>{h.x+=c,h.y+=r;let p=this.layoutMap.get(h.component.name);p.x=h.x,p.y=h.y}),a.forEach(h=>{h.x+=c,h.y+=r}),o+=c,s+=r);let l=this.diagram.relationships.map(h=>this.routeRelationship(h));l.forEach(h=>{h.path.forEach(p=>{e=Math.min(e,p.x),i=Math.min(i,p.y),o=Math.max(o,p.x),s=Math.max(s,p.y)})});let d=this.theme.padding-e,f=this.theme.padding-i;if(d>0||f>0){let h=Math.max(0,d),p=Math.max(0,f);t.forEach($=>{$.x+=h,$.y+=p}),a.forEach($=>{$.x+=h,$.y+=p}),l.forEach($=>{$.path.forEach(g=>{g.x+=h,g.y+=p}),$.labelPosition&&($.labelPosition.x+=h,$.labelPosition.y+=p)}),o+=h,s+=p}return{components:t,relationships:l,notes:a,width:o+this.theme.padding,height:s+this.theme.padding}}straightenVerticalLines(n){let t=new Set;this.diagram.components.filter(i=>i.positionHint).forEach(i=>{t.add(i.name),t.add(i.positionHint.reference)});let e=this.diagram.relationships.filter(i=>!i.direction||i.direction==="down"||i.direction==="up");if(e.length!==0)for(let i=0;i<50;i++){let o=new Map;if(e.forEach(a=>{let c=this.layoutMap.get(a.from),r=this.layoutMap.get(a.to);if(!c||!r||Math.abs(r.y-c.y)<10)return;let l=c.x+c.width/2,f=r.x+r.width/2-l;if(Math.abs(f)<.1||e.filter(y=>y.from===a.from).length>1||e.filter(y=>y.to===a.to).length>1)return;let $=this.findLowestCommonParent(a.from,a.to),g=this.getAncestorUnder(a.from,$),x=this.getAncestorUnder(a.to,$);if(g&&x&&g!==x){if(t.has(g)||t.has(x))return;o.has(g)||o.set(g,{totalShift:0,count:0}),o.has(x)||o.set(x,{totalShift:0,count:0});let y=o.get(g),M=o.get(x);y.totalShift+=f/2,y.count++,M.totalShift-=f/2,M.count++}}),o.size===0)break;let s=!1;if(o.forEach((a,c)=>{let r=a.totalShift/a.count;if(Math.abs(r)<.1)return;let l=this.layoutMap.get(c);if(l){l.x+=r,s=!0;let d=this.gridCells.get(c);d&&(d.x+=r,this.gridCells.set(c,d));let f=this.diagram.components.filter(h=>h.parentId===c);f.length>0&&this.shiftChildren(f,r,0)}}),!s)break}}findLowestCommonParent(n,t){let e=this.getAncestorPath(n),i=this.getAncestorPath(t),o;for(let s=0;s<Math.min(e.length,i.length)&&e[s]===i[s];s++)o=e[s];return o}getAncestorPath(n){let t=this.diagram.components.find(e=>e.name===n);return t&&t.parentId?[...this.getAncestorPath(t.parentId),t.parentId]:[]}getAncestorUnder(n,t){let e=this.diagram.components.find(i=>i.name===n);return e&&e.parentId!==t?this.getAncestorUnder(e.parentId,t):n}getTopLevelAncestor(n){let t=this.diagram.components.find(e=>e.name===n);return t&&t.parentId?this.getTopLevelAncestor(t.parentId):n}layoutGroup(n,t,e){if(n.length===0)return{x:t,y:e,width:0,height:0};let i=new Map;n.forEach(m=>{let u=this.theme.componentWidth,b=this.theme.componentHeight;if(m.type==="interface"){u=this.theme.interfaceRadius*2,b=this.theme.interfaceRadius*2;let k=(m.label||m.name).split(/\\n|\n/),L=Math.max(...k.map(T=>T.length))*8;u=Math.max(u,L),b+=k.length*20}else{let S=this.diagram.components.filter(L=>L.parentId===m.name),k=S.filter(L=>L.type==="port"||L.type==="portin"||L.type==="portout"),w=S.filter(L=>L.type!=="port"&&L.type!=="portin"&&L.type!=="portout");if(w.length>0){let L=this.layoutGroup(w,0,0);u=L.width+this.theme.packagePadding*2,b=L.height+this.theme.packagePadding*2+30}else{let T=(m.label||m.name).split(/\\n|\n/),X=Math.max(...T.map(j=>j.length));u=Math.max(u,X*9+20),b=Math.max(b,T.length*20+20)}}i.set(m.name,{width:u,height:b})});let o=new Set(n.map(m=>m.name)),s=new Map,a=(m,u)=>{for(let b of u.values())if(b.row===m.row&&b.col===m.col)return!0;return!1},c=n.filter(m=>m.positionHint).sort((m,u)=>m.declarationOrder-u.declarationOrder);for(let m of c){let u=m.positionHint;if(!n.find(w=>w.name===u.reference))continue;s.has(u.reference)||s.set(u.reference,{row:0,col:0});let S=s.get(u.reference),k;switch(u.position){case"right":k={row:S.row,col:S.col+1};break;case"left":k={row:S.row,col:S.col-1};break;case"bottom":k={row:S.row+1,col:S.col};break;case"top":k={row:S.row-1,col:S.col};break;default:k={row:S.row+1,col:S.col};break}for(;a(k,s);)u.position==="left"?k.col--:u.position==="right"?k.col++:u.position==="top"?k.row--:u.position==="bottom"?k.row++:k.col++;s.set(m.name,k)}let r=new Map;n.forEach(m=>{r.set(m.name,m.name),this.getAllDescendants(m.name).forEach(b=>r.set(b,m.name))});let l=[],d=new Set;this.diagram.relationships.forEach(m=>{let u=r.get(m.from),b=r.get(m.to);if(u&&b&&u!==b){let S=`${u}->${b}`;d.has(S)||(d.add(S),l.push({from:u,to:b,direction:m.direction||"down"}))}});let f=new Map;if(l.length>0){let m=new Set;l.forEach(w=>{let L=w.direction||"down";m.has(w.to)||(m.add(w.to),f.has(w.from)||f.set(w.from,[]),f.get(w.from).push({target:w.to,direction:L}))});let u=[],b=new Set,S=()=>{for(;u.length>0;){let w=u.shift();if(b.has(w))continue;b.add(w);let L=s.get(w),T=f.get(w)||[],X=new Map;T.forEach(j=>{s.has(j.target)||(X.has(j.direction)||X.set(j.direction,[]),X.get(j.direction).push(j.target))}),X.forEach((j,Z)=>{j.sort((C,z)=>{let I=n.find(N=>N.name===C),W=n.find(N=>N.name===z);return(I?.declarationOrder??0)-(W?.declarationOrder??0)}).forEach((C,z)=>{let I=L.row,W=L.col,N=j.length===1?0:z-(j.length-1)/2;switch(Z){case"down":I++;break;case"up":I--;break;case"right":W++;break;case"left":W--;break}for(;a({row:I,col:W},s);)Z==="down"||Z==="up"?W++:Z==="left"?W--:Z==="right"?W++:I++;s.set(C,{row:I,col:W}),u.push(C)})})}};for(let w of s.keys())u.push(w);S();let k=n.filter(w=>!l.some(L=>L.to===w.name)).sort((w,L)=>w.declarationOrder-L.declarationOrder);if(s.size===0&&k.length>0){let w=k[0].name;s.set(w,{row:0,col:0}),u.push(w),S()}else if(s.size===0&&l.length>0){let w=l[0].from;s.set(w,{row:0,col:0}),u.push(w),S()}for(let w of k)if(!s.has(w.name)&&l.some(L=>L.from===w.name||L.to===w.name)){let L=0;for(;a({row:0,col:L},s);)L++;s.set(w.name,{row:0,col:L}),u.push(w.name),S()}}let h=n.filter(m=>!s.has(m.name)).sort((m,u)=>m.declarationOrder-u.declarationOrder);if(h.length>0){let m=-1;s.forEach(S=>m=Math.max(m,S.row));let u=m+1,b=Math.ceil(Math.sqrt(h.length));h.forEach((S,k)=>{s.set(S.name,{row:u+Math.floor(k/b),col:k%b})})}let p=new Set;n.filter(m=>m.positionHint).forEach(m=>{p.add(m.name),p.add(m.positionHint.reference)}),n.forEach(m=>{if(p.has(m.name))return;let u=(f.get(m.name)||[]).filter(b=>b.direction==="down");if(u.length>0){let b=s.get(m.name);if(b){let S=u.map(k=>{let w=s.get(k.target);if(w&&w.row!==b.row)return w.col}).filter(k=>k!==void 0);if(S.length>0){let k=S.reduce((w,L)=>w+L,0)/S.length;b.col=Math.round(k)}}}}),(()=>{let m=1/0,u=1/0;s.forEach(k=>{m=Math.min(m,k.row),u=Math.min(u,k.col)}),s.forEach(k=>{k.row-=m,k.col-=u});let b=Array.from(s.keys()).sort((k,w)=>{let L=s.get(k),T=s.get(w);return L.row-T.row||L.col-T.col}),S=new Set;b.forEach(k=>{let w=s.get(k),L=`${w.row},${w.col}`;for(;S.has(L);)w.col++,L=`${w.row},${w.col}`;S.add(L)})})();let g=0,x=0;s.forEach(m=>{g=Math.max(g,m.row),x=Math.max(x,m.col)});let y=new Array(x+1).fill(0),M=new Array(g+1).fill(0);s.forEach((m,u)=>{let b=i.get(u);y[m.col]=Math.max(y[m.col],b.width),M[m.row]=Math.max(M[m.row],b.height)});let R=[t];for(let m=1;m<=x;m++)R[m]=R[m-1]+y[m-1]+this.theme.componentGapX;let E=[e];for(let m=1;m<=g;m++)E[m]=E[m-1]+M[m-1]+this.theme.componentGapY;n.forEach(m=>{let u=s.get(m.name),b=i.get(m.name),S=R[u.col],k=E[u.row],w=y[u.col],L=M[u.row],T=S+(w-b.width)/2,X=k+(L-b.height)/2;this.layoutMap.set(m.name,{x:T,y:X,width:b.width,height:b.height}),this.gridCells.set(m.name,{x:S,w})}),n.forEach(m=>{let u=i.get(m.name),b=this.layoutMap.get(m.name),S=b.x,k=b.y,w=this.diagram.components.filter(X=>X.parentId===m.name),L=w.filter(X=>X.type!=="port"&&X.type!=="portin"&&X.type!=="portout");L.length>0&&this.shiftChildren(L,S+this.theme.packagePadding,k+30+this.theme.packagePadding);let T=w.filter(X=>X.type==="port"||X.type==="portin"||X.type==="portout");T.length>0&&this.layoutPorts(m,T,S,k,u.width,u.height)});let v=R[x]+y[x]-t,A=E[g]+M[g]-e;return{x:t,y:e,width:v,height:A}}shiftChildren(n,t,e){n.forEach(i=>{let o=this.layoutMap.get(i.name);if(o){o.x+=t,o.y+=e,this.layoutMap.set(i.name,o);let s=this.gridCells.get(i.name);s&&(s.x+=t,this.gridCells.set(i.name,s));let a=this.diagram.components.filter(c=>c.parentId===i.name);a.length>0&&this.shiftChildren(a,t,e)}})}getAllDescendants(n){let t=[];return this.diagram.components.filter(i=>i.parentId===n).forEach(i=>{t.push(i.name),t.push(...this.getAllDescendants(i.name))}),t}findObstacle(n,t,e){let i=new Set(e),o,s=1/0;for(let[a,c]of this.layoutMap.entries())if(!i.has(a)&&this.segmentIntersectsRect(n,t,c)){let r=c.x+c.width/2,l=c.y+c.height/2,d=(r-n.x)**2+(l-n.y)**2;d<s&&(s=d,o=c)}return o}segmentIntersectsRect(n,t,e){let i=Math.min(n.x,t.x),o=Math.max(n.x,t.x),s=Math.min(n.y,t.y),a=Math.max(n.y,t.y);if(o<e.x||i>e.x+e.width||a<e.y||s>e.y+e.height)return!1;let c=e.x+e.width/2,r=e.y+e.height/2,l=(t.x-n.x)**2+(t.y-n.y)**2;if(l===0)return!1;let d=((c-n.x)*(t.x-n.x)+(r-n.y)*(t.y-n.y))/l;d=Math.max(0,Math.min(1,d));let f=n.x+d*(t.x-n.x),h=n.y+d*(t.y-n.y),p=5;return f>=e.x-p&&f<=e.x+e.width+p&&h>=e.y-p&&h<=e.y+e.height+p}routeRelationship(n){let t=this.layoutMap.get(n.from);t||(t=this.noteLayoutMap.get(n.from));let e=this.layoutMap.get(n.to);if(e||(e=this.noteLayoutMap.get(n.to)),!t||!e)return{relationship:n,path:[]};let i=this.diagram.components.find(g=>g.name===n.from),o=this.diagram.components.find(g=>g.name===n.to),s={x:t.x+t.width/2,y:t.y+t.height/2},a={x:e.x+e.width/2,y:e.y+e.height/2},c=i?.type==="interface"?this.theme.interfaceRadius:0,r=o?.type==="interface"?this.theme.interfaceRadius:0,l=this.getIntersection(s,a,t,c,i?.type==="interface"),d=this.getIntersection(a,s,e,r,o?.type==="interface"),f=[l,d],h={x:(l.x+d.x)/2,y:(l.y+d.y)/2-10},p=[n.from,n.to];i&&p.push(...this.getAncestorPath(i.name)),o&&p.push(...this.getAncestorPath(o.name));let $=this.findObstacle(l,d,p);if($){let g=a.x-s.x,x=a.y-s.y,y=n.direction?n.direction==="left"||n.direction==="right":Math.abs(g)>Math.abs(x),M={x:0,y:0},R={x:0,y:0},E="right";if(y){let m=0;x>=0?(m=$.y+$.height+40,E="down"):(m=$.y-40,E="up");let u=a.x-s.x;M={x:s.x+u*.2,y:m},R={x:s.x+u*.8,y:m}}else{let m=0;g>=0?(m=$.x+$.width+80,E="right"):(m=$.x-80,E="left");let u=a.y-s.y;M={x:m,y:s.y+u*.2},R={x:m,y:s.y+u*.8}}let v=0,A=0;E==="right"?v=1e4:E==="left"?v=-1e4:E==="down"?A=1e4:E==="up"&&(A=-1e4),l=this.getIntersection(s,{x:s.x+v,y:s.y+A},t,c,i?.type==="interface"),d=this.getIntersection(a,{x:a.x+v,y:a.y+A},e,r,o?.type==="interface"),f=[l,M,R,d],h={x:(l.x+3*M.x+3*R.x+d.x)/8,y:(l.y+3*M.y+3*R.y+d.y)/8-10}}return{relationship:n,path:f,labelPosition:h}}getIntersection(n,t,e,i=0,o=!1){let s=t.x-n.x,a=t.y-n.y,c=Math.sqrt(s*s+a*a);if(c===0)return n;if(o){let p=i/c;return{x:n.x+s*p,y:n.y+a*p}}let r=e.width/2+i,l=e.height/2+i,d=Math.abs(s),f=Math.abs(a),h=1;return d*l>f*r?h=r/d:h=l/f,{x:n.x+s*h,y:n.y+a*h}}layoutNotes(n){let t=[],e=0;return n.forEach(i=>e=Math.max(e,i.y+i.height)),e+=50,this.diagram.notes.forEach((i,o)=>{let s=i.text.split(`
`),a=Math.max(100,Math.max(...s.map(h=>h.length*8))+20),c=s.length*20+20,r=0,l=e+o*60;if(i.linkedTo){let h=n.find(p=>p.component.name===i.linkedTo);h&&(i.position==="right"?(r=h.x+h.width+30,l=h.y+(h.height-c)/2):i.position==="left"?(r=h.x-a-30,l=h.y+(h.height-c)/2):i.position==="top"?(r=h.x+(h.width-a)/2,l=h.y-c-30):i.position==="bottom"?(r=h.x+(h.width-a)/2,l=h.y+h.height+30):(r=h.x+h.width+30,l=h.y+(h.height-c)/2))}let d={note:i,x:r,y:l,width:a,height:c};t.push(d);let f=i.alias||i.id;this.noteLayoutMap.set(f,{x:r,y:l,width:a,height:c})}),t}layoutPorts(n,t,e,i,o,s){let a={top:[],bottom:[],left:[],right:[]};t.forEach(d=>{let f=this.diagram.relationships.filter(v=>v.from===d.name||v.to===d.name);if(f.length===0){d.type==="portin"?a.left.push(d):d.type==="portout"?a.right.push(d):a.left.push(d);return}let h=0,p=0,$=0;if(f.forEach(v=>{let A=v.from===d.name?v.to:v.from,m=this.layoutMap.get(A);m&&(h+=m.x+m.width/2,p+=m.y+m.height/2,$++)}),$===0){d.type==="portin"?a.left.push(d):d.type==="portout"?a.right.push(d):a.left.push(d);return}let g=h/$,x=p/$,y=e+o/2,M=i+s/2,R=g-y,E=x-M;Math.abs(R)>=Math.abs(E)?R>0?a.right.push(d):a.left.push(d):E>0?a.bottom.push(d):a.top.push(d)});let c=10,r=c/2,l=(d,f)=>{if(d.length===0)return;let h=d.length,g=(f==="left"||f==="right"?s:o)/(h+1);d.forEach((x,y)=>{let M=0,R=0;f==="left"?(M=e-r,R=i+g*(y+1)-r):f==="right"?(M=e+o-r,R=i+g*(y+1)-r):f==="top"?(M=e+g*(y+1)-r,R=i-r):f==="bottom"&&(M=e+g*(y+1)-r,R=i+s-r),this.layoutMap.set(x.name,{x:M,y:R,width:c,height:c})})};l(a.left,"left"),l(a.right,"right"),l(a.top,"top"),l(a.bottom,"bottom")}};var yt={padding:20,componentWidth:120,componentHeight:50,interfaceRadius:10,componentGapX:80,componentGapY:60,fontSize:13,packagePadding:20,colors:{defaultStroke:"#5a6270",defaultFill:"#e8edf3",interfaceFill:"#ffffff",noteFill:"#fff9c4",noteStroke:"#e0d86e",line:"#5a6270",text:"#2c3e50",textLight:"#7f8c9b",packageFill:"#ebf0f7",packageStroke:"#7b8fa8",nodeFill:"#ebf0f7",folderFill:"#ebf0f7",frameFill:"#ebf0f7",cloudFill:"#ebf0f7",databaseFill:"#ebf0f7",componentIcon:"#7b8fa8"},fontFamily:"'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif"};var ht=class{constructor(){this.theme=yt}render(n){if(n.type!=="component")throw new Error("ComponentRenderer only supports component diagrams");let t=n;this.layoutEngine=new lt(t,this.theme);let e=this.layoutEngine.calculateLayout(),i=Math.max(e.width,100),o=Math.max(e.height,100),s=`<svg xmlns="http://www.w3.org/2000/svg" width="${i}" height="${o}" viewBox="0 0 ${i} ${o}">`;return s+=`<defs>
            <marker id="comp-arrow-end" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                <polygon points="0,0 10,3.5 0,7" fill="${this.theme.colors.line}" />
            </marker>
            <marker id="comp-arrow-open" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                <polyline points="0,0 10,3.5 0,7" fill="none" stroke="${this.theme.colors.line}" stroke-width="1.5" />
            </marker>
            <filter id="comp-shadow" x="-4%" y="-4%" width="112%" height="112%">
                <feDropShadow dx="1" dy="1" stdDeviation="2" flood-color="#00000020" />
            </filter>
        </defs>`,[...e.components].sort((c,r)=>{let l=d=>{let f=0,h=d.component.parentId;for(;h;)f++,h=t.components.find(p=>p.name===h)?.parentId;return f};return l(c)-l(r)}).forEach(c=>{s+=this.renderComponentNode(c,t,e)}),e.notes.forEach(c=>{s+=this.renderNote(c)}),e.relationships.forEach(c=>{s+=this.renderRelationship(c,t)}),s+="</svg>",s}renderComponentNode(n,t,e){let{component:i}=n;switch(i.type){case"interface":return this.renderInterface(n);case"package":return this.renderPackage(n);case"node":return this.renderNode(n);case"folder":return this.renderFolder(n);case"frame":return this.renderFrame(n);case"cloud":return this.renderCloud(n);case"database":return this.renderDatabase(n);case"port":case"portin":case"portout":return this.renderPort(n,t,e);default:return this.renderComponent(n,t)}}renderComponent(n,t){let{x:e,y:i,width:o,height:s,component:a}=n,c=a.color||this.theme.colors.defaultFill,r=this.theme.colors.defaultStroke,d=(a.label||a.name).split(/\\n|\n/),f=14,h=18,p=o-20,$=6,g=8,x=5,y=t.components.some(v=>v.parentId===a.name),M=e+o/2,R=i+s/2,E="middle";return y&&(R=i+20),`
            <g filter="url(#comp-shadow)">
                <rect x="${e}" y="${i}" width="${o}" height="${s}" fill="${c}" stroke="${r}" stroke-width="1.5" rx="3" ry="3" />
                <!-- SysML Component Icon: rectangle with two tabs -->
                <rect x="${e+p}" y="${i+$}" width="${f}" height="${h}" fill="none" stroke="${this.theme.colors.componentIcon}" stroke-width="1.2" rx="1" />
                <rect x="${e+p-g/2}" y="${i+$+3}" width="${g}" height="${x}" fill="${c}" stroke="${this.theme.colors.componentIcon}" stroke-width="1" rx="0.5" />
                <rect x="${e+p-g/2}" y="${i+$+10}" width="${g}" height="${x}" fill="${c}" stroke="${this.theme.colors.componentIcon}" stroke-width="1" rx="0.5" />
                <text x="${M}" y="${R}" text-anchor="${E}" dominant-baseline="middle" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${d.map((v,A)=>`<tspan x="${M}" dy="${A===0?y?0:-((d.length-1)*.6)+"em":"1.2em"}">${_(v)}</tspan>`).join("")}
                </text>
            </g>
        `}renderInterface(n){let{x:t,y:e,width:i,height:o,component:s}=n,a=this.theme.interfaceRadius,c=t+i/2,r=e+o/2,d=(s.label||s.name).split(/\\n|\n/);return`
            <g>
                <circle cx="${c}" cy="${r}" r="${a}" fill="${this.theme.colors.interfaceFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.5"/>
                <text x="${c}" y="${r+a+16}" text-anchor="middle" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${d.map((f,h)=>`<tspan x="${c}" dy="${h===0?0:"1.2em"}">${_(f)}</tspan>`).join("")}
                </text>
            </g>
        `}renderPackage(n){let{x:t,y:e,width:i,height:o,component:s}=n,a=s.label||s.name,c=22,r=a.length*8+20,l=Math.min(Math.max(r,60),i*.6);return`
            <g filter="url(#comp-shadow)">
                <!-- Package tab -->
                <path d="M${t},${e+c} L${t},${e+3} Q${t},${e} ${t+3},${e} L${t+l-5},${e} L${t+l},${e+c}" fill="${this.theme.colors.packageFill}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <!-- Package body -->
                <rect x="${t}" y="${e+c}" width="${i}" height="${o-c}" fill="${this.theme.colors.packageFill}" fill-opacity="0.25" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" rx="1" />
                <!-- Label in tab -->
                <text x="${t+10}" y="${e+15}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${_(a)}
                </text>
            </g>
        `}renderNode(n){let{x:t,y:e,width:i,height:o,component:s}=n,a=s.label||s.name,c=10;return`
            <g filter="url(#comp-shadow)">
                <!-- Top face -->
                <polygon points="${t},${e+c} ${t+c},${e} ${t+i+c},${e} ${t+i},${e+c}" fill="${this.theme.colors.nodeFill}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.2" />
                <!-- Right face -->
                <polygon points="${t+i},${e+c} ${t+i+c},${e} ${t+i+c},${e+o} ${t+i},${e+o+c}" fill="${this.theme.colors.nodeFill}" fill-opacity="0.7" stroke="${this.theme.colors.packageStroke}" stroke-width="1.2" />
                <!-- Front face -->
                <rect x="${t}" y="${e+c}" width="${i}" height="${o}" fill="${this.theme.colors.nodeFill}" fill-opacity="0.35" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <text x="${t+10}" y="${e+c+18}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    \xABnode\xBB ${_(a)}
                </text>
            </g>
        `}renderFolder(n){let{x:t,y:e,width:i,height:o,component:s}=n,a=s.label||s.name,c=16,r=Math.min(60,i*.35);return`
            <g filter="url(#comp-shadow)">
                <!-- Folder tab -->
                <path d="M${t},${e+c} L${t},${e+3} Q${t},${e} ${t+3},${e} L${t+r-8},${e} L${t+r},${e+c}" fill="${this.theme.colors.folderFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.3" />
                <!-- Folder body -->
                <rect x="${t}" y="${e+c}" width="${i}" height="${o-c}" fill="${this.theme.colors.folderFill}" fill-opacity="0.3" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.3" rx="1" />
                <text x="${t+10}" y="${e+c+18}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${_(a)}
                </text>
            </g>
        `}renderFrame(n){let{x:t,y:e,width:i,height:o,component:s}=n,c=(s.label||s.name).split(/\\n|\n/),r=Math.max(...c.map(f=>f.length)),l=Math.min(r*8+24,i*.6),d=22+(c.length-1)*14;return`
            <g filter="url(#comp-shadow)">
                <!-- Frame body -->
                <rect x="${t}" y="${e}" width="${i}" height="${o}" fill="${this.theme.colors.frameFill}" fill-opacity="0.25" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.5" rx="2" />
                <!-- Pentagon name tag -->
                <polygon points="${t},${e} ${t+l},${e} ${t+l},${e+d-6} ${t+l-6},${e+d} ${t},${e+d}" fill="${this.theme.colors.frameFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.3" />
                <text x="${t+8}" y="${e+15}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize-1}">
                    ${c.map((f,h)=>`<tspan x="${t+8}" dy="${h===0?0:"1.2em"}">${_(f)}</tspan>`).join("")}
                </text>
            </g>
        `}renderCloud(n){let{x:t,y:e,width:i,height:o,component:s}=n,a=s.label||s.name,c=a.split(/\\n|\n/),r=i/2,l=o/2,d=i,f=o;return`
            <g transform="translate(${t}, ${e})" filter="url(#comp-shadow)">
                <path d="
                    M${d*.25},${f*.7}
                    C${d*.02},${f*.7} ${d*0},${f*.45} ${d*.15},${f*.35}
                    C${d*.1},${f*.15} ${d*.3},${f*.05} ${d*.45},${f*.2}
                    C${d*.5},${f*.05} ${d*.75},${f*.05} ${d*.78},${f*.25}
                    C${d*1},${f*.2} ${d*1.02},${f*.5} ${d*.85},${f*.6}
                    C${d*.95},${f*.75} ${d*.85},${f*.85} ${d*.7},${f*.78}
                    C${d*.6},${f*.9} ${d*.4},${f*.9} ${d*.25},${f*.7}
                    Z
                " fill="${this.theme.colors.cloudFill}" fill-opacity="0.5" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                ${a?`<text x="${r}" y="${l}" text-anchor="middle" dominant-baseline="middle" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${c.map((h,p)=>`<tspan x="${r}" dy="${p===0?-((c.length-1)*.6)+"em":"1.2em"}">${_(h)}</tspan>`).join("")}
                </text>`:""}
            </g>
        `}renderDatabase(n){let{x:t,y:e,width:i,height:o,component:s}=n,a=s.label||s.name,c=a.split(/\\n|\n/),r=12;return`
            <g transform="translate(${t}, ${e})" filter="url(#comp-shadow)">
                <!-- Cylinder body -->
                <rect x="0" y="${r}" width="${i}" height="${o-r*2}" fill="${this.theme.colors.databaseFill}" fill-opacity="0.35" stroke="none" />
                <!-- Side lines -->
                <line x1="0" y1="${r}" x2="0" y2="${o-r}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <line x1="${i}" y1="${r}" x2="${i}" y2="${o-r}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <!-- Bottom ellipse -->
                <ellipse cx="${i/2}" cy="${o-r}" rx="${i/2}" ry="${r}" fill="${this.theme.colors.databaseFill}" fill-opacity="0.35" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <!-- Top ellipse (drawn last to overlay body) -->
                <ellipse cx="${i/2}" cy="${r}" rx="${i/2}" ry="${r}" fill="${this.theme.colors.databaseFill}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                ${a?`<text x="${i/2}" y="${r+20}" text-anchor="middle" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${c.map((l,d)=>`<tspan x="${i/2}" dy="${d===0?0:"1.2em"}">${_(l)}</tspan>`).join("")}
                </text>`:""}
            </g>
        `}renderRelationship(n,t){let{path:e,relationship:i}=n;if(e.length<2)return"";let o=e[0],s=e[e.length-1],a=i.type==="dashed"?"6,4":i.type==="dotted"?"2,3":"none",c="";i.showArrowHead!==!1&&(c=i.type==="dashed"?"url(#comp-arrow-open)":"url(#comp-arrow-end)");let r=`M ${o.x} ${o.y}`;if(e.length===2)r+=` L ${s.x} ${s.y}`;else if(e.length===3)r+=` Q ${e[1].x} ${e[1].y} ${s.x} ${s.y}`;else if(e.length===4)r+=` C ${e[1].x} ${e[1].y} ${e[2].x} ${e[2].y} ${s.x} ${s.y}`;else for(let d=1;d<e.length;d++)r+=` L ${e[d].x} ${e[d].y}`;let l="";return n.labelPosition&&i.label&&(l=`
                <rect x="${n.labelPosition.x-i.label.length*3.5-4}" y="${n.labelPosition.y-10}" width="${i.label.length*7+8}" height="16" fill="white" fill-opacity="0.85" rx="3" />
                <text x="${n.labelPosition.x}" y="${n.labelPosition.y}" text-anchor="middle" dominant-baseline="middle" fill="${this.theme.colors.textLight}" font-family="${this.theme.fontFamily}" font-size="11" font-style="italic">
                    ${_(i.label)}
                </text>
            `),`
            <g>
                <path d="${r}" fill="none" stroke="${this.theme.colors.line}" stroke-width="1.3" stroke-dasharray="${a}" marker-end="${c}"/>
                ${l}
            </g>
        `}renderNote(n){let{x:t,y:e,width:i,height:o,note:s}=n,a=12;return`
            <g transform="translate(${t}, ${e})">
                <path d="M0,0 L${i-a},0 L${i},${a} L${i},${o} L0,${o} Z" fill="${this.theme.colors.noteFill}" stroke="${this.theme.colors.noteStroke}" stroke-width="1" />
                <path d="M${i-a},0 L${i-a},${a} L${i},${a}" fill="none" stroke="${this.theme.colors.noteStroke}" stroke-width="1" />
                <text x="10" y="18" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize-1}">
                    ${s.text.split(`
`).map((c,r)=>`<tspan x="10" dy="${r===0?0:"1.3em"}">${_(c)}</tspan>`).join("")}
                </text>
            </g>
        `}renderPort(n,t,e){let{x:i,y:o,width:s,height:a,component:c}=n,r=this.theme.colors.line,l="";if(c.parentId){let d=e.components.find(f=>f.component.name===c.parentId);if(d){let f=i+s/2,h=o+a/2,p=d.x+d.width/2,$=d.y+d.height/2,g=f-p,x=h-$,y=0,M=0,R="middle",E="middle",v=10;Math.abs(g)>=Math.abs(x)?g>0?(y=i+s+v/2,M=h,R="start"):(y=i-v/2,M=h,R="end"):x>0?(y=f,M=o+a+v,E="hanging"):(y=f,M=o-v/2,E="auto");let A=c.label||c.name;l=`<text x="${y}" y="${M}" text-anchor="${R}" dominant-baseline="${E}" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize-2}">${_(A)}</text>`}}return`
            <g>
                <rect x="${i}" y="${o}" width="${s}" height="${a}" fill="${this.theme.colors.defaultFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />
                ${l}
            </g>
        `}normalizeColor(n,t){return n||t}};function J(P){let n=new ot,t=new rt;try{let e=n.parse(P);return t.render(e)}catch(e){return bt(e)}}function dt(P){let n=new ct,t=new ht;try{let e=n.parse(P);return t.render(e)}catch(e){return bt(e)}}function bt(P){let t=(P.message||"Unknown error occurred during parsing").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=800,i=100;return`
        <svg width="${e}" height="${i}" viewBox="0 0 ${e} ${i}" xmlns="http://www.w3.org/2000/svg" style="background: white; font-family: sans-serif;">
            <rect width="100%" height="100%" fill="#ffeeee" stroke="#ff0000" stroke-width="2" />
            <text x="20" y="50" fill="#ff0000" font-size="16" font-weight="bold">${t}</text>
        </svg>
    `.trim()}function $t(P){let n=/\b(participant|actor|boundary|control|entity|collections|queue)\b/.test(P),t=/\b(component|package|node|cloud|database|frame|folder)\b/.test(P),e=/^\s*\[[^\]]+\]/m.test(P),i=t||e,o=n;return o&&!i?J(P):i&&!o?dt(P):/\b(alt|else|loop|group|note|opt|par|break|critical|ref)\b/.test(P)?J(P):e?dt(P):J(P)}function ft(P="pre.seeduml"){if(typeof document>"u")return;document.querySelectorAll(P).forEach(t=>{let e=t.textContent||"",i=$t(e),o=document.createElement("div");o.className="seeduml-diagram",o.innerHTML=i,o.style.display="inline-block",t.parentNode?.replaceChild(o,t)})}function wt(P={}){let{startOnLoad:n=!0,selector:t="pre.seeduml"}=P;n&&(typeof document>"u"||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{ft(t)}):ft(t)))}typeof window<"u"&&(window.seeduml={renderSequenceDiagram:J,renderComponentDiagram:dt,render:$t,renderAll:ft,initialize:wt});var oe={renderSequenceDiagram:J,renderComponentDiagram:dt,render:$t,renderAll:ft,initialize:wt};export{oe as default,wt as initialize,$t as render,ft as renderAll,dt as renderComponentDiagram,J as renderSequenceDiagram};
