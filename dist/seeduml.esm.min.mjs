var K=class{constructor(){this.type="sequence";this.participants=[];this.messages=[];this.activations=[];this.groups=[];this.references=[];this.notes=[];this.dividers=[];this.delays=[];this.spacings=[];this.timeConstraints=[];this.taggedSteps=new Map;this.hideFootbox=!1;this.currentStep=0;this.groupStack=[];this.autonumberConfig=null;this.currentAutonumber=0;this.autoactivateEnabled=!1}setHideFootbox(i){this.hideFootbox=i}addParticipant(i,t,e="participant",n,o,s){let a=this.participants.find(c=>c.name===i);a?(t&&(a.label=t),e!=="participant"&&(a.type=e),n!==void 0&&(a.order=n),o&&(a.color=o),s&&(a.stereotype=s)):(a={name:i,label:t,type:e,order:n,color:o,stereotype:s},this.participants.push(a)),this.groupStack.forEach(c=>{c.participants.includes(i)||c.participants.push(i)})}addMessage(i,t,e,n="arrow",o="default",s,a,c="none"){let r=this.currentStep++;this.addParticipant(i),this.addParticipant(t);let h;return this.autonumberConfig&&(h=this.currentAutonumber.toString(),this.currentAutonumber+=this.autonumberConfig.increment),this.messages.push({from:i,to:t,text:e,type:n,step:r,arrowHead:o,startHead:c,color:s,bidirectional:a,number:h}),this.autoactivateEnabled&&i!==t&&n==="arrow"&&this.activate(t,r,r),r}setAutonumber(i=1,t=1,e){this.autonumberConfig={start:i,increment:t,format:e},this.currentAutonumber=i}setAutoactivate(i){this.autoactivateEnabled=i}destroy(i,t){let e=this.participants.find(n=>n.name===i);e&&(e.destroyedStep=t!==void 0?t:this.currentStep++,this.deactivate(i,e.destroyedStep))}create(i,t){let e=this.participants.find(n=>n.name===i);e&&(e.createdStep=t)}addDivider(i){this.dividers.push({label:i,step:this.currentStep++})}rewindStep(){this.currentStep>0&&this.currentStep--}nextStep(){return this.currentStep++}getCurrentStep(){return this.currentStep}addDelay(i){this.delays.push({text:i,step:this.currentStep++})}addSpacing(i=30){this.spacings.push({height:i,step:this.currentStep++})}setTitle(i){this.title=i}setHeader(i){this.header=i}setFooter(i){this.footer=i}returnMessage(i){let t=[...this.activations].reverse().find(s=>s.endStep===void 0);if(!t)return;let e=t.participantName,n=e;if(t.sourceStep!==void 0){let s=this.messages.find(a=>a.step===t.sourceStep);s&&(n=s.from)}let o=this.addMessage(e,n,i,"dotted","open");this.deactivate(e,o)}addNote(i,t,e,n,o="folder",s){let a=s!==void 0?s:this.currentStep++,c=this.groupStack.length>0?this.groupStack[this.groupStack.length-1]:void 0;return this.notes.push({text:i,position:t,participants:e,step:a,color:n,shape:o,owner:c}),a}activate(i,t=this.currentStep,e,n){this.addParticipant(i);let o=this.activations.filter(s=>s.participantName===i&&s.endStep===void 0).length;this.activations.push({participantName:i,startStep:t,level:o,sourceStep:e,color:n})}deactivate(i,t=this.currentStep,e){this.addParticipant(i);let n=[...this.activations].reverse().find(o=>o.participantName===i&&o.endStep===void 0);n&&(n.endStep=t,n.endSourceStep=e)}startGroup(i,t){let e=this.nextStep(),n={type:i,label:t,startStep:e,sections:[],level:this.groupStack.length,participants:[]};return this.groups.push(n),this.groupStack.push(n),n}addGroupSection(i){let t=this.groupStack[this.groupStack.length-1];t&&t.sections.push({label:i,startStep:this.nextStep()})}endGroup(){let i=this.groupStack.pop();i&&(i.endStep=this.nextStep())}addReference(i,t){let e=this.nextStep(),n=this.nextStep();this.references.push({participants:i,label:t,startStep:e,endStep:n})}addTaggedStep(i,t){this.taggedSteps.set(i,t)}addTimeConstraint(i,t,e){this.timeConstraints.push({startTag:i,endTag:t,label:e})}};var tt=class{parse(i){let t=new K,e=i.split(`
`),n=null,o=null,s=-1,a="",c="",r="",h=new Map;for(let l=0;l<e.length;l++){let p=e[l],d=p;if(p=p.trim(),!p||p.startsWith("@")||p.startsWith("!pragma"))continue;if(o){let M=p.toLowerCase();if(M.startsWith("end note")||(M==="end hnote"||M==="endhnote")||(M==="end rnote"||M==="endrnote")||(M==="end bnote"||M==="endbnote")){let H=o.position.toLowerCase(),q;if(o.participants.length===0&&(H==="right"||H==="left")&&a&&c){let X=t.participants.findIndex(G=>G.name===a),I=t.participants.findIndex(G=>G.name===c);if(X!==-1&&I!==-1){let G=t.participants[X],j=t.participants[I],O=X<I;G.order!==void 0&&j.order!==void 0&&(O=G.order<j.order),H==="left"?o.participants=[O?a:c]:o.participants=[O?c:a]}else o.participants=[c];s!==-1&&(q=s)}let z=o.text.join(`
`).replace(/\\n/g,`
`);t.addNote(z,o.position,o.participants,o.color,o.shape,q),o=null}else o.text.push(d);continue}if(n){p.toLowerCase().startsWith("end ref")?(t.addReference(n.participants,n.label.join(`
`)),n=null):n.label.push(d);continue}if(p.startsWith("'"))continue;let f=!1;p.startsWith("/")&&(f=!0,p=p.substring(1).trim(),t.rewindStep());let g=p.match(/^create\s+(?:(actor|boundary|control|entity|database|collections)\s+)?(\w+)$/i);if(g){let[,M,L]=g;t.addParticipant(L,M),t.create(L,t.getCurrentStep());continue}let m=p.match(/^(activate|deactivate|destroy)\s+(".*?"|\w+)(?:\s+(#\w+))?$/i);if(m){let[,M,L,N]=m,F=L.replace(/^"(.*)"$/,"$1");if(N&&N.startsWith("#")){let H=N.substring(1);/^[0-9A-Fa-f]+$/.test(H)&&[3,4,6,8].includes(H.length)||(N=H)}let B=M.toLowerCase();if(B==="activate")if(F===c&&s!==-1)t.activate(F,s,s,N),h.set(F,s);else{let H=t.nextStep();t.activate(F,H,void 0,N),h.set(F,H)}else if(B==="deactivate"){let H=!1;s!==-1&&s>(h.get(F)??-1)&&(r==="arrow"?H=F===c||F===a:r==="dotted"&&(H=F===a)),H?t.deactivate(F,s):t.deactivate(F,t.nextStep())}else if(B==="destroy"){let H=!1;s!==-1&&s>(h.get(F)??-1)&&(r==="arrow"?H=F===c||F===a:r==="dotted"&&(H=F===a)),H?t.destroy(F,s):t.destroy(F,t.nextStep())}continue}let x=p.match(/^\{(\w+)\}\s*<->\s*\{(\w+)\}(?:\s*:\s*(.*))?$/);if(x){let[,M,L,N]=x;t.addTimeConstraint(M,L,N||"");continue}let S=p.match(/^\.\.\.(?:\s*(.*?)\s*\.\.\.)?$/);if(S){let[,M]=S;t.addDelay(M||void 0);continue}let C=p.match(/^(?:\{(\w+)\}\s+)?(".*?"|\w+|x|\[|\])?\s*([<ox\\/]*)([-.]+)(?:\[(#\w+)\])?([-.]*)([>ox\\/]*)?\s*(".*?"|\w+|x|\[|\])?\s*(--\+\+|\+\+--|--|\+\+|\*\*|!!)?(?:\s+(#\w+))?(?:\s*:\s*(.*))?$/i);if(C){let[,M,L,N,F,B,H,q,z,X,I,G]=C;G=G||"";let j=F+(H||"");if(j.length>0){L&&(L=L.replace(/^"(.*)"$/,"$1")),z&&(z=z.replace(/^"(.*)"$/,"$1")),(!L||L==="[")&&(L="["),(!z||z==="]")&&(z="]");let O=j.includes("..")||j.includes("--"),_=N.includes("<")&&(q||"").includes(">"),U=(T,pt)=>T?T===">"||T==="<"?"default":T===">>"||T==="<<"?"open":T==="\\"||T==="/"?"half":T==="\\\\"||T==="//"?"open":T.includes("x")?"lost":T.includes("o")?"arrow-circle":"default":"none",Z=U(q||"",!1),Q=U(N||"",!0);q==="x"&&(Z="lost"),L==="x"&&(Q="found");let xt=G.replace(/\\n/g,`
`),W=t.addMessage(L,z,xt,O?"dotted":"arrow",Z,B,_,Q);M&&t.addTaggedStep(M,W);let ht=L,dt=z,J=T=>["default","open","half","arrow-circle"].includes(T);if(J(Q)&&!J(Z)?(ht=z,dt=L):J(Z)&&!J(Q)&&(ht=L,dt=z),s=W,a=ht,c=dt,r=O?"dotted":"arrow",X==="++"){if(I&&I.startsWith("#")){let T=I.substring(1);/^[0-9A-Fa-f]+$/.test(T)&&[3,4,6,8].includes(T.length)||(I=T)}t.activate(z,W,W,I),h.set(z,W)}else if(X==="--")t.deactivate(L,W,W);else if(X==="--++"){if(t.deactivate(L,W,W),I&&I.startsWith("#")){let T=I.substring(1);/^[0-9A-Fa-f]+$/.test(T)&&[3,4,6,8].includes(T.length)||(I=T)}t.activate(z,W,W,I),h.set(z,W)}else if(X==="++--"){if(I&&I.startsWith("#")){let T=I.substring(1);/^[0-9A-Fa-f]+$/.test(T)&&[3,4,6,8].includes(T.length)||(I=T)}t.activate(L,W,W,I),h.set(L,W),t.deactivate(z,W,W)}else X==="**"?t.create(z,W):X==="!!"&&t.destroy(z,W);continue}}let u=p.match(/^(h|r|b)?note\s+(left|right|over|across)(?:\s+(?:of\s+)?([^#:]+))?\s*(#\w+)?\s*(?::\s*(.*))?$/i);if(u){let[,M,L,N,F,B]=u,H=[];N&&N.trim()&&(H=N.split(",").map(z=>z.trim().replace(/^"(.*)"$/,"$1")));let q="folder";if(M==="h"?q="hexagon":M==="r"?q="rectangle":M==="b"&&(q="bubble"),B!==void 0){let z=L.toLowerCase(),X;if(H.length===0&&(z==="right"||z==="left")&&a&&c){let G=t.participants.findIndex(O=>O.name===a),j=t.participants.findIndex(O=>O.name===c);if(G!==-1&&j!==-1){let O=t.participants[G],_=t.participants[j],U=G<j;O.order!==void 0&&_.order!==void 0&&(U=O.order<_.order),z==="left"?H=[U?a:c]:H=[U?c:a]}else H=[c];s!==-1&&(X=s)}let I=B.replace(/\\n/g,`
`);t.addNote(I,L.toLowerCase(),H,F,q,X)}else o={text:[],position:L.toLowerCase(),participants:H,color:F,shape:q};continue}let k=p.match(/^(alt|opt|loop|par|break|critical|group)(?:\s+(.*))?$/i);if(k){let[,M,L]=k;t.startGroup(M.toLowerCase(),L||"");continue}let y=p.match(/^else(?:\s+(.*))?$/i);if(y){let[,M]=y;t.addGroupSection(M||"");continue}if(p.toLowerCase().startsWith("end")){t.endGroup();continue}let v=p.match(/^ref\s+over\s+(.*?)(?:\s*:\s*(.*))?$/i);if(v){let[,M,L]=v,N=M.split(",").map(F=>F.trim().replace(/^"(.*)"$/,"$1"));L?t.addReference(N,L):n={participants:N,label:[]};continue}let $=p.match(/^return(?:\s+(.*))?$/i);if($){let[,M]=$,L=(M||"").replace(/\\n/g,`
`);t.returnMessage(L);continue}let w=p.match(/^autonumber(?:\s+(\d+))?(?:\s+(\d+))?(?:\s+"(.*?)"|)$/i);if(w){let[,M,L,N]=w;t.setAutonumber(M?parseInt(M,10):1,L?parseInt(L,10):1,N);continue}let b=p.match(/^autoactivate\s+(on|off)$/i);if(b){t.setAutoactivate(b[1].toLowerCase()==="on");continue}let E=p.match(/^==\s*(.*?)\s*==$/);if(E){t.addDivider(E[1]);continue}if(p==="|||"){t.addSpacing();continue}let R=p.match(/^\|\|(\d+)\|\|$/);if(R){t.addSpacing(parseInt(R[1],10));continue}let D=p.match(/^(title|header|footer)\s+(.*)$/i);if(D){let[,M,L]=D;M.toLowerCase()==="title"?t.setTitle(L):M.toLowerCase()==="header"?t.setHeader(L):M.toLowerCase()==="footer"&&t.setFooter(L);continue}if(p.toLowerCase()==="hide footbox"){t.setHideFootbox(!0);continue}let Y="(participant|actor|boundary|control|entity|database|collections|queue)",P=new RegExp(`^${Y}\\s+(".*?"|\\w+)\\s*(?:<<\\s*(.*?)\\s*>>)?(?:\\s+as\\s+(".*?"|\\w+))?\\s*(?:<<\\s*(.*?)\\s*>>)?(?:\\s+order\\s+(\\d+))?(?:\\s+(#\\w+))?$`,"i"),V=p.match(P);if(V){let[,M,L,N,F,B,H,q]=V;if(!M||!L)continue;let z=N||B,X,I;F?F.startsWith('"')?(X=L.replace(/^"(.*)"$/,"$1"),I=F.replace(/^"(.*)"$/,"$1")):(X=F.replace(/^"(.*)"$/,"$1"),I=L.replace(/^"(.*)"$/,"$1")):(X=L.replace(/^"(.*)"$/,"$1"),I=void 0);let G=H?parseInt(H,10):void 0;t.addParticipant(X,I,M.toLowerCase(),G,q,z);continue}if(d.trim()!==""&&!d.trim().startsWith("'"))throw new Error(`Syntax error at line ${l+1}: ${p}`)}return t}};var mt={padding:40,participantWidth:120,participantHeight:40,participantGap:180,defaultMessageGap:50,fontSize:14,activationWidth:12,colors:{defaultStroke:"#333333",defaultFill:"#eeeeee",actorFill:"#f8f9fa",noteFill:"#ffffcc",line:"#666666",text:"#000000"},fontFamily:"sans-serif"};var et=class{constructor(i){this.theme=i}calculateLayout(i){let t=[...i.participants].sort((k,y)=>k.order!==void 0&&y.order!==void 0?k.order-y.order:k.order!==void 0?-1:y.order!==void 0?1:0),e=this.calculateMaxStep(i);this.finalizeEndSteps(i,e);let n=this.calculateStepHeights(i,e),o=n.stepY,s=n.totalHeight,a=t.map(k=>this.calculateParticipantWidth(k)),c=this.calculateGaps(i,t,a),r=this.calculateRelativepCenterXs(t,a,c),h=this.preCalculateNoteLayouts(i,t,r,a,o),l=this.calculateBounds(t,r,a,h,i.messages),p=this.theme.padding-l.minX,d=l.maxX-l.minX+this.theme.padding*2,f=d;if(i.timeConstraints.length>0){let y=50+Math.max(...i.timeConstraints.map(v=>v.label.length),0)*8;f+=y}let g=i.hideFootbox?0:this.theme.participantHeight+20,m=s+g+this.theme.padding,x=t.map((k,y)=>{let v=r[y]+p;return{participant:k,centerX:v,x:v-a[y]/2,y:k.createdStep!==void 0?o[k.createdStep]-this.theme.participantHeight/2:this.theme.padding,width:a[y],height:this.theme.participantHeight,destroyedY:k.destroyedStep!==void 0?o[k.destroyedStep]:void 0}}),S=[];h.forEach((k,y)=>{let v=k.x+p,$=k.width;y.position==="across"&&(v=this.theme.padding,$=Math.max(d-this.theme.padding*2,k.width)),S.push({note:y,x:v,y:k.y,width:$,height:k.height})});let C=this.calculateGroupLayouts(i,x,S,o,e),u=this.calculateActivationLayouts(i,x,o,i.messages);return{width:f,height:m,participants:x,notes:S,dividers:this.calculateDividerLayouts(i,o,f),references:this.calculateReferenceLayouts(i,x,o),messages:this.calculateMessageLayouts(i,x,o,u),groups:C,activations:u,delays:this.calculateDelayLayouts(i,o),timeConstraints:this.calculateTimeConstraintLayouts(i,x,o,d)}}calculateMessageLayouts(i,t,e,n){return i.messages.map(o=>{let s=t.findIndex(d=>d.participant.name===o.from),a=t.findIndex(d=>d.participant.name===o.to),c=e[o.step],r=s!==-1?t[s].centerX:0,h=a!==-1?t[a].centerX:0;if(s!==-1&&a!==-1){let d=n.filter(g=>g.activation.participantName===o.from&&g.activation.startStep<=o.step&&(g.activation.endStep??1/0)>=o.step).sort((g,m)=>m.activation.level-g.activation.level),f=n.filter(g=>g.activation.participantName===o.to&&g.activation.startStep<=o.step&&(g.activation.endStep??1/0)>=o.step).sort((g,m)=>m.activation.level-g.activation.level);s!==a&&(s<a?(d.length>0&&(r=d[0].x+d[0].width),f.length>0&&(h=f[0].x)):(d.length>0&&(r=d[0].x),f.length>0&&(h=f[0].x+f[0].width)))}a!==-1&&t[a].participant.createdStep===o.step&&(h=t[a].x);let l=[{x:r,y:c},{x:h,y:c}],p={x:(r+h)/2,y:c};if(s===a&&s!==-1){let d=n.filter(m=>m.activation.participantName===o.from&&m.activation.startStep<=o.step&&(m.activation.endStep??1/0)>=o.step).sort((m,x)=>x.activation.level-m.activation.level),f=0,g=0;if(d.length>0){let m=d[0];m.activation.startStep===o.step?d.length>1?(f=1,g=0):(f=void 0,g=0):m.activation.endStep===o.step&&(d.length>1?(f=0,g=1):(f=0,g=void 0));let x=f!==void 0&&d.length>f?d[f].x+d[f].width:t[s].centerX,S=g!==void 0&&d.length>g?d[g].x+d[g].width:t[s].centerX,C=40;l[0]={x,y:c},l[1]={x:Math.max(x,S)+C,y:c},l.push({x:Math.max(x,S)+C,y:c+25}),l.push({x:S,y:c+25}),p={x:Math.max(x,S)+C+5,y:c+10}}else{let m=t[s].centerX,x=40;l[0]={x:m,y:c},l[1]={x:m+x,y:c},l.push({x:m+x,y:c+25}),l.push({x:m,y:c+25}),p={x:m+x+5,y:c+10}}}return{message:o,y:c,points:l,labelPosition:p,lineStyle:o.type==="dotted"?"dashed":"solid"}})}calculateDividerLayouts(i,t,e){return i.dividers.map(n=>({y:t[n.step],label:n.label}))}calculateDelayLayouts(i,t){return i.delays.map(e=>({y:t[e.step],text:e.text}))}calculateTimeConstraintLayouts(i,t,e,n){return i.timeConstraints.map(o=>{let s=i.taggedSteps.get(o.startTag),a=i.taggedSteps.get(o.endTag);return s===void 0||a===void 0?null:{x:n-this.theme.padding+20,startY:e[s],endY:e[a],label:o.label}}).filter(o=>o!==null)}calculateReferenceLayouts(i,t,e){return i.references.map(n=>{let o=n.participants.map(p=>t.findIndex(d=>d.participant.name===p)).filter(p=>p!==-1);if(o.length===0)return null;let s=Math.min(...o),a=Math.max(...o),c=t[s].x,r=t[a].x+t[a].width-c,h=e[n.startStep]-10,l=e[n.endStep]-h;return{reference:n,x:c,y:h,width:r,height:l}}).filter(n=>n!==null)}calculateActivationLayouts(i,t,e,n){return i.activations.map(o=>{let s=t.findIndex(d=>d.participant.name===o.participantName);if(s===-1)return null;let c=t[s].centerX-this.theme.activationWidth/2+o.level*5,r=e[o.startStep];if(o.sourceStep!==void 0){let d=n.find(f=>f.step===o.sourceStep);d&&d.from===o.participantName&&d.to===o.participantName&&(r+=25)}let h=e[o.endStep];if(o.endSourceStep!==void 0){let d=n.find(f=>f.step===o.endSourceStep);d&&d.from===o.participantName&&d.to===o.participantName&&(h+=25)}let p=Math.max(5,h-r);return{activation:o,x:c,y:r,width:this.theme.activationWidth,height:p}}).filter(o=>o!==null)}calculateMaxStep(i){let t=0;return[...i.messages,...i.activations,...i.groups,...i.references,...i.notes,...i.dividers,...i.delays,...i.spacings].forEach(n=>{let o=n.step??n.startStep??n.endStep??0;o>t&&(t=o)}),t+1}finalizeEndSteps(i,t){i.activations.forEach(e=>{e.endStep===void 0&&(e.endStep=t)}),i.groups.forEach(e=>{e.endStep===void 0&&(e.endStep=t)})}calculateStepHeights(i,t){let e=new Array(t+1).fill(this.theme.defaultMessageGap),n=new Array(t+2).fill(0),o=new Array(t+2).fill(0);i.notes.forEach(r=>{let l=r.text.split(`
`).length*20+10;n[r.step]=Math.max(n[r.step],l/2),o[r.step]=Math.max(o[r.step],l/2)}),i.messages.forEach(r=>{let l=r.text.split(`
`).length;if(r.from===r.to){let p=Math.max(25,l*20);n[r.step]=Math.max(n[r.step],0),o[r.step]=Math.max(o[r.step],p+10)}else{let p=l*15+5;n[r.step]=Math.max(n[r.step],p),o[r.step]=Math.max(o[r.step],0)}});let s=new Array(t+1).fill(this.theme.defaultMessageGap);i.dividers.forEach(r=>{s[r.step]=30}),i.delays.forEach(r=>{s[r.step]=40}),i.spacings.forEach(r=>{s[r.step]=r.height}),i.references.forEach(r=>{let l=r.label.split(`
`).length*15+40;r.endStep===r.startStep+1&&(s[r.startStep]=Math.max(s[r.startStep],l))});for(let r=0;r<=t;r++){let h=o[r]+n[r+1]+10;e[r]=Math.max(s[r],h)}let a=new Array(t+1).fill(0),c=this.theme.padding+90;for(let r=0;r<=t;r++)a[r]=c,c+=e[r];return{stepY:a,totalHeight:c}}calculateParticipantWidth(i){let e=(i.label||i.name).replace(/\\n/g,`
`).split(`
`),n=Math.max(...e.map(o=>o.length));return Math.max(this.theme.participantWidth,n*9+30)}calculateGaps(i,t,e){let n=Math.max(0,t.length-1),o=new Array(n).fill(60),s=this.calculateMaxStep(i);for(let a=0;a<=s;a++){let c=new Array(n).fill(0);for(let r=0;r<t.length;r++){let h=t[r].name;if(t[r].createdStep===a){let S=e[r];r<n&&(c[r]=Math.max(c[r],S/2+20))}let p=15,d=i.messages.find(S=>S.step===a&&S.from===h&&S.to===h);d&&(p=40+(Math.max(...d.text.split(`
`).map(C=>C.length*8))+20)+10);let f=i.activations.filter(S=>S.participantName===h&&S.startStep<=a&&(S.endStep??1/0)>=a);if(f.length>0){let S=Math.max(...f.map(C=>C.level));p=Math.max(p,this.theme.activationWidth/2+S*5+10)}i.notes.filter(S=>S.step===a&&S.position==="right"&&S.participants?.includes(h)).forEach(S=>{let C=Math.max(60,Math.max(...S.text.split(`
`).map(u=>u.length*8.5))+20);p+=C+10}),r<n&&(c[r]+=p);let m=15;i.notes.filter(S=>S.step===a&&S.position==="left"&&S.participants?.includes(h)).forEach(S=>{let C=Math.max(60,Math.max(...S.text.split(`
`).map(u=>u.length*8.5))+20);m+=C+10}),r>0&&(c[r-1]+=m)}for(let r=0;r<n;r++)o[r]=Math.max(o[r],c[r])}return i.messages.forEach(a=>{let c=t.findIndex(f=>f.name===a.from),r=t.findIndex(f=>f.name===a.to);if(c===-1||r===-1||c===r)return;let h=Math.max(...a.text.split(`
`).map(f=>f.length*8))+20,l=Math.min(c,r),p=Math.max(c,r),d=0;for(let f=l;f<p;f++)d+=e[f]/2+o[f]+e[f+1]/2;if(d<h){let g=(h-d)/(p-l);for(let m=l;m<p;m++)o[m]+=g}}),i.notes.forEach(a=>{if(a.position!=="over"&&a.position!=="across")return;let c=a.text.split(`
`),r=Math.max(60,Math.max(...c.map(h=>h.length*8.5))+20);if(a.participants&&a.participants.length>0){let h=t.findIndex(f=>f.name===a.participants[0]),l=a.participants.length>1?t.findIndex(f=>f.name===a.participants[1]):h;if(h===-1||l===-1)return;let p=Math.min(h,l),d=Math.max(h,l);if(p===d){let f=r/2+10;p<n&&o[p]<f&&(o[p]=f)}else{let f=0;for(let g=p;g<d;g++)f+=e[g]/2+o[g]+e[g+1]/2;if(f<r){let m=(r-f)/(d-p);for(let x=p;x<d;x++)o[x]+=m}}}}),o}calculateRelativepCenterXs(i,t,e){let n=new Array(i.length).fill(0);return i.forEach((o,s)=>{s===0?n[s]=t[s]/2:n[s]=n[s-1]+t[s-1]/2+e[s-1]+t[s]/2}),n}preCalculateNoteLayouts(i,t,e,n,o){let s=new Map,a=new Map;return i.notes.forEach(c=>{let r=c.text.split(`
`),h=Math.max(...r.map(m=>m.length*8.5))+20,p=Math.max(h,60),d=r.length*20+10,f=o[c.step]-d/2,g=0;if(c.position==="across")g=0,s.set(c,{x:g,y:f,width:p,height:d});else if(c.position==="over"){let m=c.participants.map(x=>t.findIndex(S=>S.name===x)).filter(x=>x!==-1);if(m.length>0){let x=Math.min(...m),S=Math.max(...m),C=e[S]+n[S]/2-(e[x]-n[x]/2),u=Math.max(C,p);g=e[x]-n[x]/2-(u-C)/2,s.set(c,{x:g,y:f,width:u,height:d})}}else{let m=(c.participants||[]).map(x=>t.findIndex(S=>S.name===x)).filter(x=>x!==-1);if(m.length>0){let x=c.position==="left"?Math.min(...m):Math.max(...m),S=e[x],C=`${c.step}-${x}-${c.position}`,u=t[x],k=n[x]/2,v=c.step===u.createdStep?k:0;if(c.position==="left")g=(a.get(C)??S-v-5)-p,a.set(C,g-10);else{let $=i.messages.find(P=>P.step===c.step&&P.from===u.name&&P.to===u.name),w=0;if($){let P=$.text.split(`
`);w=40+(Math.max(...P.map(M=>M.length*8))+20)}let b=i.activations.filter(P=>P.participantName===u.name&&P.startStep<=c.step&&(P.endStep??1/0)>=c.step),E=b.length>0?Math.max(...b.map(P=>P.level)):0,R=this.theme.activationWidth/2+E*5,D=Math.max(v,R,w);g=a.get(C)??S+D+5,a.set(C,g+p+10)}s.set(c,{x:g,y:f,width:p,height:d})}}}),s}calculateBounds(i,t,e,n,o){let s=0,a=0;return i.forEach((c,r)=>{let h=t[r]-e[r]/2,l=t[r]+e[r]/2;r===0?(s=h,a=l):(h<s&&(s=h),l>a&&(a=l))}),n.forEach(c=>{c.x<s&&(s=c.x),c.x+c.width>a&&(a=c.x+c.width)}),o.forEach(c=>{let r=i.findIndex(d=>d.name===c.from),h=i.findIndex(d=>d.name===c.to);if(r===-1||h===-1)return;let l=c.text.split(`
`),p=Math.max(...l.map(d=>d.length*8))+20;if(r===h){let d=t[r],f=Math.max(...c.text.split(`
`).map(m=>m.length*8))+20,g=d+40+f+10;g>a&&(a=g)}else{let d=t[r],f=t[h],g=(d+f)/2,m=g-p/2,x=g+p/2;m<s&&(s=m),x>a&&(a=x)}}),{minX:s,maxX:a}}calculateGroupLayouts(i,t,e,n,o){let s=i.groups.length>0?Math.max(...i.groups.map(a=>a.level)):0;return i.groups.map(a=>{let c=a.participants.map(y=>t.findIndex(v=>v.participant.name===y)).filter(y=>y!==-1);if(c.length===0)return null;let r=Math.min(...c),h=Math.max(...c),l=s-a.level,p=10+l*10,d=25+l*8,f=5+l*8,g=t[r].x+t[r].width/2-t[r].width/2-p,m=t[r].x-p,x=t[h].x+t[h].width+p-m;e.filter(y=>{let v=y.note;if(v.step<a.startStep||v.step>(a.endStep||o))return!1;let $=v.owner;if(!$)return!1;if($===a)return!0;let w=$.endStep??o,b=a.endStep??o;return $.startStep>=a.startStep&&w<=b}).forEach(y=>{let v=y.note;if(v.position==="right"){let $=(v.participants||[]).map(w=>t.findIndex(b=>b.participant.name===w)).filter(w=>w!==-1);if($.length>0&&Math.max(...$)===h){let w=y.x+y.width,b=m+x;w+10>b&&(x=w+10-m)}}else if(v.position==="left"){let $=(v.participants||[]).map(w=>t.findIndex(b=>b.participant.name===w)).filter(w=>w!==-1);if($.length>0&&Math.min(...$)===r){let w=y.x,b=m;if(w-10<b){let E=b-(w-10);m-=E,x+=E}}}});let C=n[a.startStep]-d,u=n[a.endStep]+f,k=a.sections.map(y=>({label:y.label,y:n[y.startStep]}));return{group:a,x:m,y:C,width:x,height:u-C,type:a.type,label:a.label,sections:k}}).filter(a=>a!==null)}};var nt=class{constructor(){this.theme=mt;this.lastSvg="";this.layoutEngine=new et(this.theme)}render(i){this.ensureParticipants(i);let t=this.layoutEngine.calculateLayout(i);return this.generateSvg(i,t)}ensureParticipants(i){i.notes.forEach(t=>{t.participants&&t.participants.forEach(e=>i.addParticipant(e))})}generateSvg(i,t){let e=`<svg width="${t.width}" height="${t.height}" viewBox="0 0 ${t.width} ${t.height}" xmlns="http://www.w3.org/2000/svg" style="background: white; font-family: ${this.theme.fontFamily};">`;return e+=this.renderDefs(i),e+=this.renderLifelines(i,t),e+=this.renderActivations(i,t),e+=this.renderGroups(t),e+=this.renderParticipants(i,t),e+=this.renderReferences(i,t),e+=this.renderNotes(t),e+=this.renderMessages(i,t),e+=this.renderDividers(i,t),e+=this.renderDelays(i,t),e+=this.renderTimeConstraints(t),e+=this.renderDestructionMarks(t),i.title&&(e+=`<text x="${t.width/2}" y="25" text-anchor="middle" font-size="${this.theme.fontSize+4}" font-weight="bold">${i.title}</text>`),i.header&&(e+=`<text x="${t.width-this.theme.padding}" y="15" text-anchor="end" font-size="${this.theme.fontSize-4}">${i.header}</text>`),i.footer&&(e+=`<text x="${t.width/2}" y="${t.height-10}" text-anchor="middle" font-size="${this.theme.fontSize-4}">${i.footer}</text>`),e+="</svg>",e}renderDefs(i){let t=new Set;t.add(this.theme.colors.defaultStroke),i.messages.forEach(n=>{t.add(this.normalizeColor(n.color,this.theme.colors.defaultStroke))});let e="<defs>";return t.forEach(n=>{let o=n.replace("#","");e+=`
      <marker id="arrowhead-${o}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="${n}" />
      </marker>
      <marker id="arrowhead-reverse-${o}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="10 0, 0 3.5, 10 7" fill="${n}" />
      </marker>
      <marker id="arrowhead-open-${o}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <path d="M 0 0 L 10 3.5 L 0 7" fill="none" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="arrowhead-open-reverse-${o}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <path d="M 10 0 L 0 3.5 L 10 7" fill="none" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="halfhead-${o}" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 3.5" fill="${n}" />
      </marker>
      <marker id="halfhead-reverse-${o}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
        <polygon points="10 0, 0 3.5, 10 3.5" fill="${n}" />
      </marker>
      <marker id="circlehead-${o}" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
        <circle cx="4" cy="4" r="3" fill="white" stroke="${n}" stroke-width="1.5" />
      </marker>
      <marker id="arrowhead-circle-${o}" markerWidth="18" markerHeight="7.5" refX="14" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="${n}" />
        <circle cx="14" cy="3.5" r="3" fill="${n}" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="arrowhead-circle-reverse-${o}" markerWidth="18" markerHeight="7.5" refX="4" refY="3.5" orient="auto">
        <polygon points="17 0, 7 3.5, 17 7" fill="${n}" />
        <circle cx="4" cy="3.5" r="3" fill="${n}" stroke="${n}" stroke-width="1" />
      </marker>
      <marker id="losthead-${o}" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
        <line x1="0" y1="0" x2="10" y2="10" stroke="${n}" stroke-width="2" />
        <line x1="10" y1="0" x2="0" y2="10" stroke="${n}" stroke-width="2" />
      </marker>`}),e+="</defs>",e}renderLifelines(i,t){let e="";return t.participants.forEach(n=>{if(n.participant.name==="["||n.participant.name==="]")return;let o=n.centerX,s=n.destroyedY!==void 0?n.destroyedY:i.hideFootbox?t.height-this.theme.padding:t.height-this.theme.padding-this.theme.participantHeight;e+=`<line x1="${o}" y1="${n.y+n.height}" x2="${o}" y2="${s}" stroke="${this.theme.colors.line}" stroke-dasharray="4" />`}),e}renderDestructionMarks(i){let t="";return i.participants.forEach(e=>{if(e.destroyedY!==void 0){let n=e.centerX,o=e.destroyedY,s=12;t+=`<line x1="${n-s}" y1="${o-s}" x2="${n+s}" y2="${o+s}" stroke="#FF0000" stroke-width="3" />`,t+=`<line x1="${n+s}" y1="${o-s}" x2="${n-s}" y2="${o+s}" stroke="#FF0000" stroke-width="3" />`}}),t}renderParticipants(i,t){let e="",n=(o,s)=>{let a=this.normalizeColor(o.participant.color,this.theme.colors.actorFill),c=o.x,r=s?o.y:t.height-this.theme.padding-this.theme.participantHeight-20,h=o.centerX,l=r+this.theme.participantHeight/2,d=(o.participant.label||o.participant.name).replace(/\\n/g,`
`).split(`
`);switch(o.participant.type){case"actor":e+=`<circle cx="${h}" cy="${r+10}" r="8" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h}" y1="${r+18}" x2="${h}" y2="${r+30}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h-10}" y1="${r+22}" x2="${h+10}" y2="${r+22}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h}" y1="${r+30}" x2="${h-8}" y2="${r+40}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h}" y1="${r+30}" x2="${h+8}" y2="${r+40}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((R,D)=>{e+=`<text x="${h}" y="${r+55+D*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;case"boundary":e+=`<line x1="${h-20}" y1="${l}" x2="${h-10}" y2="${l}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h-20}" y1="${l-10}" x2="${h-20}" y2="${l+10}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<circle cx="${h}" cy="${l}" r="14" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((R,D)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+D*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;case"control":e+=`<circle cx="${h}" cy="${l}" r="14" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${h+4} ${l-18} L ${h-4} ${l-14} L ${h+4} ${l-10}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((R,D)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+D*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;case"entity":e+=`<circle cx="${h}" cy="${l}" r="14" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<line x1="${h-14}" y1="${l+14}" x2="${h+14}" y2="${l+14}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((R,D)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+D*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;case"database":let f=34,g=40,m=r,x=h-f/2;e+=`<path d="M ${x} ${m+10} L ${x} ${m+g-10} A 17 8 0 0 0 ${x+f} ${m+g-10} L ${x+f} ${m+10} A 17 8 0 0 0 ${x} ${m+10} M ${x} ${m+10} A 17 8 0 0 1 ${x+f} ${m+10}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${x} ${m+10} A 17 8 0 0 0 ${x+f} ${m+10}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((R,D)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+D*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;case"collections":let S=34,C=34,u=r+3,k=h-S/2;e+=`<rect x="${k+4}" y="${u-4}" width="${S}" height="${C}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<rect x="${k}" y="${u}" width="${S}" height="${C}" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((R,D)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+D*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;case"queue":let y=40,v=40,$=r+3,w=h-y/2,b=5,E=v/2;e+=`<path d="M ${w+y} ${$} L ${w} ${$} A ${b} ${E} 0 0 0 ${w} ${$+v} L ${w+y} ${$+v} A ${b} ${E} 0 0 0 ${w+y} ${$}" fill="${a}" stroke="none" />`,e+=`<ellipse cx="${w+y}" cy="${$+E}" rx="${b}" ry="${E}" fill="${a}" stroke="none" />`,e+=`<path d="M ${w+y} ${$} L ${w} ${$} A ${b} ${E} 0 0 0 ${w} ${$+v} L ${w+y} ${$+v}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<ellipse cx="${w+y}" cy="${$+E}" rx="${b}" ry="${E}" fill="none" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((R,D)=>{e+=`<text x="${h}" y="${r+this.theme.participantHeight+20+D*15}" text-anchor="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`});break;default:e+=`<rect x="${c}" y="${r}" width="${o.width}" height="${this.theme.participantHeight}" rx="5" fill="${a}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,d.forEach((R,D)=>{let Y=d.length>1?l-(d.length-1)*7.5+D*15:l;e+=`<text x="${h}" y="${Y}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}" font-weight="bold">${R}</text>`})}};return t.participants.forEach(o=>{o.participant.name==="["||o.participant.name==="]"||(n(o,!0),i.hideFootbox||n(o,!1))}),e}renderGroups(i){let t="";return i.groups.forEach(e=>{t+=`<rect x="${e.x}" y="${e.y}" width="${e.width}" height="${e.height}" fill="none" stroke="#222" stroke-width="2" rx="5" />`,t+=`<path d="M ${e.x} ${e.y} L ${e.x+70} ${e.y} L ${e.x+70} ${e.y+10} L ${e.x+60} ${e.y+20} L ${e.x} ${e.y+20} Z" fill="#eee" stroke="#222" stroke-width="2" />`,t+=`<text x="${e.x+5}" y="${e.y+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">${e.type}</text>`,e.label&&(t+=`<text x="${e.x+75}" y="${e.y+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">[${e.label}]</text>`),e.sections.forEach(n=>{let o=n.y;t+=`<line x1="${e.x}" y1="${o}" x2="${e.x+e.width}" y2="${o}" stroke="#222" stroke-width="1" stroke-dasharray="5,5" />`,t+=`<text x="${e.x+5}" y="${o+15}" font-size="${this.theme.fontSize-2}" font-weight="bold">[${n.label}]</text>`})}),t}renderNotes(i){let t="";return i.notes.forEach(e=>{this.drawNoteShape(t,e.x,e.y,e.width,e.height,e.note.shape,e.note.color,e.note.text),t=this.lastSvg}),t}renderActivations(i,t){let e="";return[...t.activations].sort((o,s)=>o.activation.level-s.activation.level).forEach(o=>{let s=o.activation.color||this.theme.colors.actorFill;e+=`<rect x="${o.x}" y="${o.y}" width="${o.width}" height="${o.height}" fill="${s}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`}),e}renderReferences(i,t){let e="";return t.references.forEach(n=>{e+=`<rect x="${n.x}" y="${n.y}" width="${n.width}" height="${n.height}" fill="${this.theme.colors.defaultFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="2" />`,e+=`<path d="M ${n.x} ${n.y} L ${n.x+70} ${n.y} L ${n.x+70} ${n.y+10} L ${n.x+60} ${n.y+20} L ${n.x} ${n.y+20} Z" fill="#eee" stroke="#222" stroke-width="2" />`,e+=`<text x="${n.x+5}" y="${n.y+12}" font-size="${this.theme.fontSize-2}" font-weight="bold">ref</text>`;let o=n.reference.label.split(`
`),s=this.theme.fontSize+2,a=o.length*s,c=25,r=n.y+n.height/2-a/2+s/2;r<n.y+c+s/2&&(r=n.y+c+s/2),o.forEach((h,l)=>{e+=`<text x="${n.x+n.width/2}" y="${r+l*s}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}">${h}</text>`})}),e}renderMessages(i,t){let e="";return t.messages.forEach(n=>{let o=n.message,s=this.normalizeColor(o.color,this.theme.colors.defaultStroke),a=n.lineStyle==="dashed"?"4":"0",c=s.replace("#",""),r=(g,m)=>{if(g==="none")return"none";let x="";return g==="default"?x=m?`arrowhead-reverse-${c}`:`arrowhead-${c}`:g==="open"?x=m?`arrowhead-open-reverse-${c}`:`arrowhead-open-${c}`:g==="half"?x=m?`halfhead-reverse-${c}`:`halfhead-${c}`:g==="circle"?x=`circlehead-${c}`:g==="arrow-circle"?x=m?`arrowhead-circle-reverse-${c}`:`arrowhead-circle-${c}`:g==="lost"?x=`losthead-${c}`:g==="found"&&(x=`circlehead-${c}`),x?`url(#${x})`:"none"},h=r(o.arrowHead||"default",!1),l=r(o.startHead||(o.bidirectional?"default":"none"),!0);if(n.points.length>2){let g=`M ${n.points.map(m=>`${m.x} ${m.y}`).join(" L ")}`;e+=`<path d="${g}" fill="none" stroke="${s}" stroke-width="1.5" stroke-dasharray="${a}" marker-end="${h}" marker-start="${l}" />`}else{let[g,m]=n.points;e+=`<line x1="${g.x}" y1="${g.y}" x2="${m.x}" y2="${m.y}" stroke="${s}" stroke-width="1.5" stroke-dasharray="${a}" marker-end="${h}" marker-start="${l}" />`}let d=(o.number?`[${o.number}] ${o.text}`:o.text).split(`
`),f=n.points.length>2?"start":"middle";d.forEach((g,m)=>{let S=n.labelPosition.y-(d.length-1-m)*15-5;n.points.length>2&&(S=n.labelPosition.y+m*20),e+=`<text x="${n.labelPosition.x}" y="${S}" text-anchor="${f}" font-size="${this.theme.fontSize-2}" fill="${s}">${g}</text>`})}),e}renderDividers(i,t){let e="";return t.dividers.forEach(n=>{let o=n.y;if(e+=`<line x1="${this.theme.padding}" y1="${o}" x2="${t.width-this.theme.padding}" y2="${o}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,e+=`<line x1="${this.theme.padding}" y1="${o+4}" x2="${t.width-this.theme.padding}" y2="${o+4}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,n.label){let s=n.label.length*9+20;e+=`<rect x="${t.width/2-s/2}" y="${o-10}" width="${s}" height="20" fill="white" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />`,e+=`<text x="${t.width/2}" y="${o}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize-2}" font-weight="bold">${n.label}</text>`}}),e}renderDelays(i,t){let e="";return t.delays.forEach(n=>{let o=n.y,s=t.width/2,a=10,c=5;if(n.text){let r=n.text.length*8+20;e+=`<text x="${s}" y="${o}" text-anchor="middle" dominant-baseline="middle" font-size="${this.theme.fontSize}" fill="${this.theme.colors.text}">${n.text}</text>`;for(let h=0;h<c;h++){let l=s-r/2-10-h*a;e+=`<circle cx="${l}" cy="${o}" r="1.5" fill="${this.theme.colors.text}" />`}for(let h=0;h<c;h++){let l=s+r/2+10+h*a;e+=`<circle cx="${l}" cy="${o}" r="1.5" fill="${this.theme.colors.text}" />`}}else for(let r=-10;r<=10;r++)r!==0&&(e+=`<circle cx="${s+r*a}" cy="${o}" r="1.5" fill="${this.theme.colors.text}" />`)}),e}renderTimeConstraints(i){let t="";return i.timeConstraints.forEach(e=>{let n=e.x,o=e.startY,s=e.endY,a=this.theme.colors.defaultStroke;if(t+=`<line x1="${n}" y1="${o}" x2="${n}" y2="${s}" stroke="${a}" stroke-width="1.5" />`,t+=`<polygon points="${n} ${o}, ${n-4} ${o+8}, ${n+4} ${o+8}" fill="${a}" />`,t+=`<polygon points="${n} ${s}, ${n-4} ${s-8}, ${n+4} ${s-8}" fill="${a}" />`,e.label){let c=(o+s)/2;t+=`<text x="${n+10}" y="${c}" text-anchor="start" dominant-baseline="middle" font-size="${this.theme.fontSize-2}" fill="${a}">${e.label}</text>`}}),t}normalizeColor(i,t){return i?i.startsWith("#")?/^#[0-9a-fA-F]{3,8}$/.test(i)?i:i.substring(1):i:t}formatRichText(i){let t=i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");return t=t.replace(/\*\*(.*?)\*\*/g,'<tspan font-weight="bold">$1</tspan>'),t=t.replace(/\/\/(.*?)\/\//g,'<tspan font-style="italic">$1</tspan>'),t=t.replace(/""(.*?)""/g,'<tspan font-family="monospace">$1</tspan>'),t=t.replace(/--(.*?)--/g,'<tspan text-decoration="line-through">$1</tspan>'),t=t.replace(/__(.*?)__/g,'<tspan text-decoration="underline">$1</tspan>'),t=t.replace(/~~(.*?)~~/g,'<tspan style="text-decoration: underline; text-decoration-style: wavy">$1</tspan>'),t}drawNoteShape(i,t,e,n,o,s,a,c){let r="",h=this.normalizeColor(a,this.theme.colors.noteFill),l=this.theme.colors.defaultStroke,p=s||"folder";if(p==="hexagon"){let g=[`${t+10},${e}`,`${t+n-10},${e}`,`${t+n},${e+o/2}`,`${t+n-10},${e+o}`,`${t+10},${e+o}`,`${t},${e+o/2}`].join(" ");r+=`<polygon points="${g}" fill="${h}" stroke="${l}" stroke-width="1.5" />`}else if(p==="bubble"){let f=o/2;r+=`<rect x="${t}" y="${e}" width="${n}" height="${o}" rx="${f}" ry="${f}" fill="${h}" stroke="${l}" stroke-width="1.5" />`}else if(p==="rectangle")r+=`<rect x="${t}" y="${e}" width="${n}" height="${o}" fill="${h}" stroke="${l}" stroke-width="1.5" />`;else{let g=`
                M ${t} ${e}
                L ${t+n-10} ${e}
                L ${t+n} ${e+10}
                L ${t+n} ${e+o}
                L ${t} ${e+o}
                Z
            `;r+=`<path d="${g}" fill="${h}" stroke="${l}" stroke-width="1.5" />`;let m=`
                M ${t+n-10} ${e}
                L ${t+n-10} ${e+10}
                L ${t+n} ${e+10}
            `;r+=`<path d="${m}" fill="none" stroke="${l}" stroke-width="1.5" />`}c.split(`
`).forEach((f,g)=>{r+=`<text x="${t+n/2}" y="${e+20+g*20}" text-anchor="middle" font-size="${this.theme.fontSize}" fill="${this.theme.colors.text}">${this.formatRichText(f)}</text>`}),this.lastSvg=i+r}};var it=class{constructor(){this.type="component";this.components=[];this.relationships=[];this.notes=[]}addComponent(i,t,e,n,o){let s=this.components.find(a=>a.name===i);return s?(e&&(s.label=e),n&&(s.parentId=n),o&&(s.color=o),t!=="component"&&s.type==="component"&&(s.type=t)):(s={name:i,type:t,label:e||i,isVisible:!0,parentId:n,color:o},this.components.push(s)),s}addRelationship(i,t,e="solid",n,o,s=!0,a){this.relationships.push({from:i,to:t,type:e,label:n,direction:o,showArrowHead:s})}addNote(i,t,e,n){let o=`note_${this.notes.length}`;this.notes.push({text:i,position:t,linkedTo:e,id:o,alias:n})}findComponent(i){return this.components.find(t=>t.name===i||t.alias===i)}};var ot=class{parse(i){let t=new it,e=i.split(`
`),n=new Set,o=new Set;for(let c=0;c<e.length;c++){let r=e[c].trim();if(!r||r.startsWith("'")||r.startsWith("@"))continue;let h=r.match(/^component\s+(?:\[(.*?)\]|(".*?"|\S+))(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(h){n.add(h[3]||h[1]||(h[2]?h[2].replace(/^"(.*)"$/,"$1"):""));continue}let l=r.match(/^interface\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(l){n.add(l[2]||l[1].replace(/^"(.*)"$/,"$1"));continue}let p=r.match(/^\(\)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(p){n.add(p[2]||p[1].replace(/^"(.*)"$/,"$1"));continue}let d=r.match(/^\[([^\]]+)\](?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(d){n.add(d[2]||d[1]);continue}let f=r.match(/^(port|portin|portout)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?$/i);if(f){n.add(f[3]||f[2].replace(/^"(.*)"$/,"$1"));continue}let g=r.match(/^note\s+as\s+(\S+)$/i);if(g){o.add(g[1]);continue}}let s=null,a=[];for(let c=0;c<e.length;c++){let r=e[c].trim();if(!r||r.startsWith("'")||r.startsWith("@"))continue;if(s){if(r.endsWith("]"))if(s.isDescription&&s.linkedTo){let $=s.text.join(`
`),w=t.findComponent(s.linkedTo);w&&(w.label=$),s=null}else r.toLowerCase()==="end note"?(t.addNote(s.text.join(`
`),s.position,s.linkedTo,s.alias),s=null):s.text.push(r);else if(r.toLowerCase()==="end note"&&!s.isDescription)t.addNote(s.text.join(`
`),s.position,s.linkedTo,s.alias),s=null;else if(s.isDescription&&r.endsWith("]")){let $=r.substring(0,r.length-1).trim();$&&s.text.push($);let w=s.text.join(`
`),b=t.findComponent(s.linkedTo);b&&(b.label=w),s=null}else s.text.push(r);continue}let h=a.length>0?a[a.length-1]:void 0,l=r.match(/^component\s+(?:\[(.*?)\]|(".*?"|\S+))(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(l){let $=l[1],w=l[2],b=l[3],E=l[4],R=$||(w?w.replace(/^"(.*)"$/,"$1"):""),D=b||R;t.addComponent(D,"component",R,h,this.parseColor(E)),r.trim().endsWith("[")&&(s={text:[],linkedTo:D,alias:void 0,isDescription:!0});continue}let p=r.match(/^interface\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/i);if(p){let $=p[1].replace(/^"(.*)"$/,"$1"),w=p[2],b=p[3];t.addComponent(w||$,"interface",$,h,this.parseColor(b)),r.trim().endsWith("[")&&(s={text:[],linkedTo:w||$,alias:void 0,isDescription:!0});continue}let d=r.match(/^\(\)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(d){let $=d[1].replace(/^"(.*)"$/,"$1"),w=d[2],b=d[3];t.addComponent(w||$,"interface",$,h,this.parseColor(b));continue}let f=r.match(/^\[([^\]]+)\](?:\s+as\s+(\S+))?(?:\s+(#\w+))?(?:\s*\[)?$/);if(f){let $=f[1],w=f[2],b=f[3],E=w||$;t.addComponent(E,"component",$,h,this.parseColor(b)),r.trim().endsWith("[")&&(s={text:[],linkedTo:E,alias:void 0,isDescription:!0});continue}let g=r.match(/^(package|node|folder|frame|cloud|database|component|interface)(?:\s+(".*?"|\S+))?\s*\{$/i);if(g){let $=g[1].toLowerCase(),w=g[2],b=w?w.replace(/^"(.*)"$/,"$1"):$;if(w)t.addComponent(b,$,b,h);else{let E=t.components.filter(R=>R.type===$).length;b=`${$}_${E}_${c}`,t.addComponent(b,$,"",h)}a.push(b);continue}if(r==="}"){a.pop();continue}let m=r.match(/^(port|portin|portout)\s+(".*?"|\S+)(?:\s+as\s+(\S+))?$/i);if(m){let $=m[1].toLowerCase(),w=m[2].replace(/^"(.*)"$/,"$1"),b=m[3],E="port";$==="portin"&&(E="portin"),$==="portout"&&(E="portout"),t.addComponent(b||w,E,w,h);continue}let x='(?:\\[([^\\]]+)\\]|(".*?"|[^\\s-]+))',S="([-.]+[^[\\]\\s]*)",C="(?:\\s+|(?<=[^\\s])(?=[-.])|(?<=[-.])(?=[^\\s]))",u=new RegExp(`^${x}${C}${S}${C}${x}(?:\\s*:\\s*(.*))?$`),k=r.match(u);if(k){let $=k[1]||k[2],w=!!k[1],b=k[3],E=k[4]||k[5],R=!!k[4],D=k[6],Y=$.replace(/^"(.*)"$/,"$1"),P=E.replace(/^"(.*)"$/,"$1");if(!t.components.some(N=>N.name===Y)&&!o.has(Y)){let N=w?"component":"interface";t.addComponent(Y,N,Y,h)}if(!t.components.some(N=>N.name===P)&&!o.has(P)){let N=R?"component":"interface";t.addComponent(P,N,P,h)}let V="solid";b.includes("..")?V="dashed":b.includes("--")&&(V="solid");let M;if(b.includes("left")||b.includes("le")?M="left":b.includes("right")||b.includes("ri")?M="right":b.includes("up")?M="up":(b.includes("down")||b.includes("do"))&&(M="down"),!M){let F=b.replace(/[<>]/g,"").match(/(-+|\.+)/);F&&(M=F[1].length>=2?"down":"right")}let L=b.includes(">");t.addRelationship(Y,P,V,D,M,L,h);continue}let y=r.match(/^note\s+as\s+(\S+)$/i);if(y){let $=y[1];s={text:[],alias:$};continue}let v=r.match(/^note\s+(left|right|top|bottom)\s+of\s+(?:\[(.*?)\]|(".*?"|\S+))(?:\s*:\s*(.*))?$/i);if(v){let $=v[1].toLowerCase(),b=(v[2]||v[3]).replace(/^"(.*)"$/,"$1"),E=!!v[2];t.findComponent(b)||t.addComponent(b,E?"component":"interface");let R=v[4];R?t.addNote(R,$,b):s={text:[],position:$,linkedTo:b};continue}}return t}parseColor(i){if(i){if(i.startsWith("#")){let t=i.substring(1);return/^([0-9a-fA-F]{3}|[0-9a-fA-F]{4}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/.test(t)?i:t}return i}}};var st=class{constructor(i,t){this.diagram=i;this.theme=t;this.layoutMap=new Map;this.gridCells=new Map;this.noteLayoutMap=new Map}calculateLayout(){this.layoutMap.clear();let i=this.diagram.components.filter(l=>!l.parentId);this.layoutGroup(i,0,0);let t=[];this.layoutMap.forEach((l,p)=>{let d=this.diagram.components.find(f=>f.name===p);d&&t.push({...l,component:d})}),this.straightenVerticalLines(t),t.forEach(l=>{let p=this.layoutMap.get(l.component.name);p&&(l.x=p.x,l.y=p.y)});let e=1/0,n=1/0,o=-1/0,s=-1/0;t.forEach(l=>{e=Math.min(e,l.x),n=Math.min(n,l.y),o=Math.max(o,l.x+l.width),s=Math.max(s,l.y+l.height)});let a=this.layoutNotes(t);a.forEach(l=>{e=Math.min(e,l.x),n=Math.min(n,l.y),o=Math.max(o,l.x+l.width),s=Math.max(s,l.y+l.height)});let c=this.theme.padding-e,r=this.theme.padding-n;(c!==0||r!==0)&&(t.forEach(l=>{l.x+=c,l.y+=r;let p=this.layoutMap.get(l.component.name);p.x=l.x,p.y=l.y}),a.forEach(l=>{l.x+=c,l.y+=r}),o+=c,s+=r);let h=this.diagram.relationships.map(l=>this.routeRelationship(l));return{components:t,relationships:h,notes:a,width:o+this.theme.padding,height:s+this.theme.padding}}straightenVerticalLines(i){let t=this.diagram.relationships.filter(e=>!e.direction||e.direction==="down"||e.direction==="up");if(t.length!==0)for(let e=0;e<50;e++){let n=new Map;if(t.forEach(s=>{let a=this.layoutMap.get(s.from),c=this.layoutMap.get(s.to);if(!a||!c)return;let r=a.x+a.width/2,l=c.x+c.width/2-r;if(Math.abs(l)<.1||t.filter(x=>x.from===s.from).length>1||t.filter(x=>x.to===s.to).length>1)return;let f=this.findLowestCommonParent(s.from,s.to),g=this.getAncestorUnder(s.from,f),m=this.getAncestorUnder(s.to,f);if(g&&m&&g!==m){n.has(g)||n.set(g,{totalShift:0,count:0}),n.has(m)||n.set(m,{totalShift:0,count:0});let x=n.get(g),S=n.get(m);x.totalShift+=l/2,x.count++,S.totalShift-=l/2,S.count++}}),n.size===0)break;let o=!1;if(n.forEach((s,a)=>{let c=s.totalShift/s.count;if(Math.abs(c)<.1)return;let r=this.layoutMap.get(a);if(r){r.x+=c,o=!0;let h=this.gridCells.get(a);h&&(h.x+=c,this.gridCells.set(a,h));let l=this.diagram.components.filter(p=>p.parentId===a);l.length>0&&this.shiftChildren(l,c,0)}}),!o)break}}findLowestCommonParent(i,t){let e=this.getAncestorPath(i),n=this.getAncestorPath(t),o;for(let s=0;s<Math.min(e.length,n.length)&&e[s]===n[s];s++)o=e[s];return o}getAncestorPath(i){let t=this.diagram.components.find(e=>e.name===i);return t&&t.parentId?[...this.getAncestorPath(t.parentId),t.parentId]:[]}getAncestorUnder(i,t){let e=this.diagram.components.find(n=>n.name===i);return e&&e.parentId!==t?this.getAncestorUnder(e.parentId,t):i}getTopLevelAncestor(i){let t=this.diagram.components.find(e=>e.name===i);return t&&t.parentId?this.getTopLevelAncestor(t.parentId):i}layoutGroup(i,t,e){if(i.length===0)return{x:t,y:e,width:0,height:0};let n=new Map;i.forEach(u=>{let k=this.theme.componentWidth,y=this.theme.componentHeight;if(u.type==="interface"){k=this.theme.interfaceRadius*2,y=this.theme.interfaceRadius*2;let $=(u.label||u.name).length*8;k=Math.max(k,$),y+=20}else{let v=this.diagram.components.filter(b=>b.parentId===u.name),$=v.filter(b=>b.type==="port"||b.type==="portin"||b.type==="portout"),w=v.filter(b=>b.type!=="port"&&b.type!=="portin"&&b.type!=="portout");if(w.length>0){let b=this.layoutGroup(w,0,0);k=b.width+this.theme.packagePadding*2,y=b.height+this.theme.packagePadding*2+30}else{let E=(u.label||u.name).split(/\\n|\n/),R=Math.max(...E.map(D=>D.length));k=Math.max(k,R*9+20),y=Math.max(y,E.length*20+20)}}n.set(u.name,{width:k,height:y})});let o=new Set(i.map(u=>u.name)),s=new Map,a=new Map;i.forEach(u=>{a.set(u.name,u.name),this.getAllDescendants(u.name).forEach(y=>a.set(y,u.name))});let c=[],r=new Set;if(this.diagram.relationships.forEach(u=>{let k=a.get(u.from),y=a.get(u.to);if(k&&y&&k!==y){let v=`${k}->${y}`;r.has(v)||(r.add(v),c.push({from:k,to:y,direction:u.direction||"down"}))}}),c.length>0){let u=new Map;c.forEach(w=>{let b=w.direction||"down";u.has(w.from)||u.set(w.from,[]),u.get(w.from).push({target:w.to,direction:b}),u.has(w.to)||u.set(w.to,[]);let E=b==="down"?"up":b==="up"?"down":b==="right"?"left":"right";u.get(w.to).push({target:w.from,direction:E})});let k=[],y=i.filter(w=>!c.some(b=>b.to===w.name)),v=y.length>0?y[0].name:c[0].from;s.set(v,{row:0,col:0}),k.push(v);let $=new Set;for(;k.length>0;){let w=k.shift();if($.has(w))continue;$.add(w);let b=s.get(w),E=u.get(w)||[],R=new Map;E.forEach(D=>{s.has(D.target)||(R.has(D.direction)||R.set(D.direction,[]),R.get(D.direction).push(D.target))}),R.forEach((D,Y)=>{D.forEach((P,V)=>{let M=b.row,L=b.col,N=D.length===1?0:V-(D.length-1)/2;switch(Y){case"down":M++,L+=Math.round(N*1.5);break;case"up":M--,L+=Math.round(N*1.5);break;case"right":L++,M+=Math.round(N*1.5);break;case"left":L--,M+=Math.round(N*1.5);break}let F=(B,H)=>{for(let q of s.values())if(q.row===B&&q.col===H)return!0;return!1};for(;F(M,L);)Y==="down"||Y==="up"?L++:M++;s.set(P,{row:M,col:L}),k.push(P)})})}}let h=i.filter(u=>!s.has(u.name));if(h.length>0){let u=-1;s.forEach(v=>u=Math.max(u,v.row));let k=u+1,y=Math.ceil(Math.sqrt(h.length));h.forEach((v,$)=>{s.set(v.name,{row:k+Math.floor($/y),col:$%y})})}i.forEach(u=>{let k=c.filter(y=>y.from===u.name&&y.direction==="down");if(k.length>0){let y=s.get(u.name);if(y){let v=k.map($=>s.get($.to)?.col).filter($=>$!==void 0);if(v.length>0){let $=v.reduce((w,b)=>w+b,0)/v.length;y.col=Math.round($)}}}}),(()=>{let u=1/0,k=1/0;s.forEach($=>{u=Math.min(u,$.row),k=Math.min(k,$.col)}),s.forEach($=>{$.row-=u,$.col-=k});let y=Array.from(s.keys()).sort(($,w)=>{let b=s.get($),E=s.get(w);return b.row-E.row||b.col-E.col}),v=new Set;y.forEach($=>{let w=s.get($),b=`${w.row},${w.col}`;for(;v.has(b);)w.col++,b=`${w.row},${w.col}`;v.add(b)})})();let p=0,d=0;s.forEach(u=>{p=Math.max(p,u.row),d=Math.max(d,u.col)});let f=new Array(d+1).fill(0),g=new Array(p+1).fill(0);s.forEach((u,k)=>{let y=n.get(k);f[u.col]=Math.max(f[u.col],y.width),g[u.row]=Math.max(g[u.row],y.height)});let m=[t];for(let u=1;u<=d;u++)m[u]=m[u-1]+f[u-1]+this.theme.componentGapX;let x=[e];for(let u=1;u<=p;u++)x[u]=x[u-1]+g[u-1]+this.theme.componentGapY;console.log("--- Grid Layout Details ---"),console.log("Col Widths:",f),console.log("Col Starts:",m),console.log("Row Heights:",g),console.log("Row Starts:",x),i.forEach(u=>{let k=s.get(u.name),y=n.get(u.name),v=m[k.col],$=x[k.row],w=f[k.col],b=g[k.row],E=v+(w-y.width)/2,R=$+(b-y.height)/2;this.layoutMap.set(u.name,{x:E,y:R,width:y.width,height:y.height}),this.gridCells.set(u.name,{x:v,w})}),i.forEach(u=>{let k=n.get(u.name),y=this.layoutMap.get(u.name),v=y.x,$=y.y,w=this.diagram.components.filter(R=>R.parentId===u.name),b=w.filter(R=>R.type!=="port"&&R.type!=="portin"&&R.type!=="portout");b.length>0&&this.shiftChildren(b,v+this.theme.packagePadding,$+30+this.theme.packagePadding);let E=w.filter(R=>R.type==="port"||R.type==="portin"||R.type==="portout");E.length>0&&this.layoutPorts(u,E,v,$,k.width,k.height)});let S=m[d]+f[d]-t,C=x[p]+g[p]-e;return{x:t,y:e,width:S,height:C}}shiftChildren(i,t,e){i.forEach(n=>{let o=this.layoutMap.get(n.name);if(o){o.x+=t,o.y+=e,this.layoutMap.set(n.name,o);let s=this.gridCells.get(n.name);s&&(s.x+=t,this.gridCells.set(n.name,s));let a=this.diagram.components.filter(c=>c.parentId===n.name);a.length>0&&this.shiftChildren(a,t,e)}})}getAllDescendants(i){let t=[];return this.diagram.components.filter(n=>n.parentId===i).forEach(n=>{t.push(n.name),t.push(...this.getAllDescendants(n.name))}),t}routeRelationship(i){let t=this.layoutMap.get(i.from);t||(t=this.noteLayoutMap.get(i.from));let e=this.layoutMap.get(i.to);if(e||(e=this.noteLayoutMap.get(i.to)),!t||!e)return{relationship:i,path:[]};let n=this.diagram.components.find(p=>p.name===i.from),o=this.diagram.components.find(p=>p.name===i.to),s={x:t.x+t.width/2,y:t.y+t.height/2},a={x:e.x+e.width/2,y:e.y+e.height/2},c=n?.type==="interface"?this.theme.interfaceRadius+2:5,r=o?.type==="interface"?this.theme.interfaceRadius+2:10,h=this.getIntersection(s,a,t,c,n?.type==="interface"),l=this.getIntersection(a,s,e,r,o?.type==="interface");return{relationship:i,path:[h,l],labelPosition:{x:(h.x+l.x)/2,y:(h.y+l.y)/2-10}}}getIntersection(i,t,e,n=0,o=!1){let s=t.x-i.x,a=t.y-i.y,c=Math.sqrt(s*s+a*a);if(c===0)return i;if(o){let f=n/c;return{x:i.x+s*f,y:i.y+a*f}}let r=e.width/2+n,h=e.height/2+n,l=Math.abs(s),p=Math.abs(a),d=1;return l*h>p*r?d=r/l:d=h/p,{x:i.x+s*d,y:i.y+a*d}}layoutNotes(i){let t=[],e=0;return i.forEach(n=>e=Math.max(e,n.y+n.height)),e+=50,this.diagram.notes.forEach((n,o)=>{let s=n.text.split(`
`),a=Math.max(100,Math.max(...s.map(d=>d.length*8))+20),c=s.length*20+20,r=0,h=e+o*60;if(n.linkedTo){let d=i.find(f=>f.component.name===n.linkedTo);d&&(n.position==="right"?(r=d.x+d.width+30,h=d.y+(d.height-c)/2):n.position==="left"?(r=d.x-a-30,h=d.y+(d.height-c)/2):n.position==="top"?(r=d.x+(d.width-a)/2,h=d.y-c-30):n.position==="bottom"?(r=d.x+(d.width-a)/2,h=d.y+d.height+30):(r=d.x+d.width+30,h=d.y+(d.height-c)/2))}let l={note:n,x:r,y:h,width:a,height:c};t.push(l);let p=n.alias||n.id;this.noteLayoutMap.set(p,{x:r,y:h,width:a,height:c})}),t}layoutPorts(i,t,e,n,o,s){let a={top:[],bottom:[],left:[],right:[]};t.forEach(l=>{let p=this.diagram.relationships.filter(y=>y.from===l.name||y.to===l.name);if(p.length===0){l.type==="portin"?a.left.push(l):l.type==="portout"?a.right.push(l):a.left.push(l);return}let d=0,f=0,g=0;if(p.forEach(y=>{let v=y.from===l.name?y.to:y.from,$=this.layoutMap.get(v);$&&(d+=$.x+$.width/2,f+=$.y+$.height/2,g++)}),g===0){l.type==="portin"?a.left.push(l):l.type==="portout"?a.right.push(l):a.left.push(l);return}let m=d/g,x=f/g,S=e+o/2,C=n+s/2,u=m-S,k=x-C;Math.abs(u)>=Math.abs(k)?u>0?a.right.push(l):a.left.push(l):k>0?a.bottom.push(l):a.top.push(l)});let c=10,r=c/2,h=(l,p)=>{if(l.length===0)return;let d=l.length,m=(p==="left"||p==="right"?s:o)/(d+1);l.forEach((x,S)=>{let C=0,u=0;p==="left"?(C=e-r,u=n+m*(S+1)-r):p==="right"?(C=e+o-r,u=n+m*(S+1)-r):p==="top"?(C=e+m*(S+1)-r,u=n-r):p==="bottom"&&(C=e+m*(S+1)-r,u=n+s-r),this.layoutMap.set(x.name,{x:C,y:u,width:c,height:c})})};h(a.left,"left"),h(a.right,"right"),h(a.top,"top"),h(a.bottom,"bottom")}};var ut={padding:20,componentWidth:120,componentHeight:50,interfaceRadius:10,componentGapX:80,componentGapY:60,fontSize:13,packagePadding:20,colors:{defaultStroke:"#5a6270",defaultFill:"#e8edf3",interfaceFill:"#ffffff",noteFill:"#fff9c4",noteStroke:"#e0d86e",line:"#5a6270",text:"#2c3e50",textLight:"#7f8c9b",packageFill:"#ebf0f7",packageStroke:"#7b8fa8",nodeFill:"#ebf0f7",folderFill:"#ebf0f7",frameFill:"#ebf0f7",cloudFill:"#ebf0f7",databaseFill:"#ebf0f7",componentIcon:"#7b8fa8"},fontFamily:"'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif"};var rt=class{constructor(){this.theme=ut}render(i){if(i.type!=="component")throw new Error("ComponentSVGRenderer only supports component diagrams");let t=i;this.layoutEngine=new st(t,this.theme);let e=this.layoutEngine.calculateLayout(),n=Math.max(e.width,100),o=Math.max(e.height,100),s=`<svg xmlns="http://www.w3.org/2000/svg" width="${n}" height="${o}" viewBox="0 0 ${n} ${o}">`;return s+=`<defs>
            <marker id="comp-arrow-end" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                <polygon points="0,0 10,3.5 0,7" fill="${this.theme.colors.line}" />
            </marker>
            <marker id="comp-arrow-open" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                <polyline points="0,0 10,3.5 0,7" fill="none" stroke="${this.theme.colors.line}" stroke-width="1.5" />
            </marker>
            <filter id="comp-shadow" x="-4%" y="-4%" width="112%" height="112%">
                <feDropShadow dx="1" dy="1" stdDeviation="2" flood-color="#00000020" />
            </filter>
        </defs>`,[...e.components].sort((c,r)=>{let h=l=>{let p=0,d=l.component.parentId;for(;d;)p++,d=t.components.find(f=>f.name===d)?.parentId;return p};return h(c)-h(r)}).forEach(c=>{s+=this.renderComponentNode(c,t,e)}),e.notes.forEach(c=>{s+=this.renderNote(c)}),e.relationships.forEach(c=>{s+=this.renderRelationship(c,t)}),s+="</svg>",s}renderComponentNode(i,t,e){let{component:n}=i;switch(n.type){case"interface":return this.renderInterface(i);case"package":return this.renderPackage(i);case"node":return this.renderNode(i);case"folder":return this.renderFolder(i);case"frame":return this.renderFrame(i);case"cloud":return this.renderCloud(i);case"database":return this.renderDatabase(i);case"port":case"portin":case"portout":return this.renderPort(i,t,e);default:return this.renderComponent(i,t)}}renderComponent(i,t){let{x:e,y:n,width:o,height:s,component:a}=i,c=a.color||this.theme.colors.defaultFill,r=this.theme.colors.defaultStroke,l=(a.label||a.name).split(/\\n|\n/),p=14,d=18,f=6,g=6,m=8,x=5,S=t.components.some(y=>y.parentId===a.name),C=e+o/2,u=n+s/2,k="middle";return S&&(u=n+20),`
            <g filter="url(#comp-shadow)">
                <rect x="${e}" y="${n}" width="${o}" height="${s}" fill="${c}" stroke="${r}" stroke-width="1.5" rx="3" ry="3" />
                <!-- SysML Component Icon: rectangle with two tabs -->
                <rect x="${e+f}" y="${n+g}" width="${p}" height="${d}" fill="none" stroke="${this.theme.colors.componentIcon}" stroke-width="1.2" rx="1" />
                <rect x="${e+f-m/2}" y="${n+g+3}" width="${m}" height="${x}" fill="${c}" stroke="${this.theme.colors.componentIcon}" stroke-width="1" rx="0.5" />
                <rect x="${e+f-m/2}" y="${n+g+10}" width="${m}" height="${x}" fill="${c}" stroke="${this.theme.colors.componentIcon}" stroke-width="1" rx="0.5" />
                <text x="${C}" y="${u}" text-anchor="${k}" dominant-baseline="middle" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${l.map((y,v)=>`<tspan x="${C}" dy="${v===0?S?0:-((l.length-1)*.6)+"em":"1.2em"}">${this.escapeXml(y)}</tspan>`).join("")}
                </text>
            </g>
        `}renderInterface(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=this.theme.interfaceRadius,c=t+n/2,r=e+o/2;return`
            <g>
                <circle cx="${c}" cy="${r}" r="${a}" fill="${this.theme.colors.interfaceFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.5"/>
                <text x="${c}" y="${r+a+16}" text-anchor="middle" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${this.escapeXml(s.label||s.name)}
                </text>
            </g>
        `}renderPackage(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=22,r=a.length*8+20,h=Math.min(Math.max(r,60),n*.6);return`
            <g filter="url(#comp-shadow)">
                <!-- Package tab -->
                <path d="M${t},${e+c} L${t},${e+3} Q${t},${e} ${t+3},${e} L${t+h-5},${e} L${t+h},${e+c}" fill="${this.theme.colors.packageFill}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <!-- Package body -->
                <rect x="${t}" y="${e+c}" width="${n}" height="${o-c}" fill="${this.theme.colors.packageFill}" fill-opacity="0.25" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" rx="1" />
                <!-- Label in tab -->
                <text x="${t+10}" y="${e+15}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${this.escapeXml(a)}
                </text>
            </g>
        `}renderNode(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=10;return`
            <g filter="url(#comp-shadow)">
                <!-- Top face -->
                <polygon points="${t},${e+c} ${t+c},${e} ${t+n+c},${e} ${t+n},${e+c}" fill="${this.theme.colors.nodeFill}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.2" />
                <!-- Right face -->
                <polygon points="${t+n},${e+c} ${t+n+c},${e} ${t+n+c},${e+o} ${t+n},${e+o+c}" fill="${this.theme.colors.nodeFill}" fill-opacity="0.7" stroke="${this.theme.colors.packageStroke}" stroke-width="1.2" />
                <!-- Front face -->
                <rect x="${t}" y="${e+c}" width="${n}" height="${o}" fill="${this.theme.colors.nodeFill}" fill-opacity="0.35" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <text x="${t+10}" y="${e+c+18}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    \xABnode\xBB ${this.escapeXml(a)}
                </text>
            </g>
        `}renderFolder(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=16,r=Math.min(60,n*.35);return`
            <g filter="url(#comp-shadow)">
                <!-- Folder tab -->
                <path d="M${t},${e+c} L${t},${e+3} Q${t},${e} ${t+3},${e} L${t+r-8},${e} L${t+r},${e+c}" fill="${this.theme.colors.folderFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.3" />
                <!-- Folder body -->
                <rect x="${t}" y="${e+c}" width="${n}" height="${o-c}" fill="${this.theme.colors.folderFill}" fill-opacity="0.3" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.3" rx="1" />
                <text x="${t+10}" y="${e+c+18}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${this.escapeXml(a)}
                </text>
            </g>
        `}renderFrame(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=Math.min(a.length*8+24,n*.6),r=22;return`
            <g filter="url(#comp-shadow)">
                <!-- Frame body -->
                <rect x="${t}" y="${e}" width="${n}" height="${o}" fill="${this.theme.colors.frameFill}" fill-opacity="0.25" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.5" rx="2" />
                <!-- Pentagon name tag -->
                <polygon points="${t},${e} ${t+c},${e} ${t+c},${e+r-6} ${t+c-6},${e+r} ${t},${e+r}" fill="${this.theme.colors.frameFill}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1.3" />
                <text x="${t+8}" y="${e+15}" text-anchor="start" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize-1}">
                    ${this.escapeXml(a)}
                </text>
            </g>
        `}renderCloud(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=n/2,r=o/2,h=n,l=o;return`
            <g transform="translate(${t}, ${e})" filter="url(#comp-shadow)">
                <path d="
                    M${h*.25},${l*.7}
                    C${h*.02},${l*.7} ${h*0},${l*.45} ${h*.15},${l*.35}
                    C${h*.1},${l*.15} ${h*.3},${l*.05} ${h*.45},${l*.2}
                    C${h*.5},${l*.05} ${h*.75},${l*.05} ${h*.78},${l*.25}
                    C${h*1},${l*.2} ${h*1.02},${l*.5} ${h*.85},${l*.6}
                    C${h*.95},${l*.75} ${h*.85},${l*.85} ${h*.7},${l*.78}
                    C${h*.6},${l*.9} ${h*.4},${l*.9} ${h*.25},${l*.7}
                    Z
                " fill="${this.theme.colors.cloudFill}" fill-opacity="0.5" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                ${a?`<text x="${c}" y="${r+5}" text-anchor="middle" dominant-baseline="middle" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${this.escapeXml(a)}
                </text>`:""}
            </g>
        `}renderDatabase(i){let{x:t,y:e,width:n,height:o,component:s}=i,a=s.label||s.name,c=12;return`
            <g transform="translate(${t}, ${e})" filter="url(#comp-shadow)">
                <!-- Cylinder body -->
                <rect x="0" y="${c}" width="${n}" height="${o-c*2}" fill="${this.theme.colors.databaseFill}" fill-opacity="0.35" stroke="none" />
                <!-- Side lines -->
                <line x1="0" y1="${c}" x2="0" y2="${o-c}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <line x1="${n}" y1="${c}" x2="${n}" y2="${o-c}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <!-- Bottom ellipse -->
                <ellipse cx="${n/2}" cy="${o-c}" rx="${n/2}" ry="${c}" fill="${this.theme.colors.databaseFill}" fill-opacity="0.35" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                <!-- Top ellipse (drawn last to overlay body) -->
                <ellipse cx="${n/2}" cy="${c}" rx="${n/2}" ry="${c}" fill="${this.theme.colors.databaseFill}" stroke="${this.theme.colors.packageStroke}" stroke-width="1.5" />
                ${a?`<text x="${n/2}" y="${c+20}" text-anchor="middle" font-weight="600" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize}">
                    ${this.escapeXml(a)}
                </text>`:""}
            </g>
        `}renderRelationship(i,t){let{path:e,relationship:n}=i;if(e.length<2)return"";let o=e[0],s=e[e.length-1],a=n.type==="dashed"?"6,4":n.type==="dotted"?"2,3":"none",c="";n.showArrowHead!==!1&&(c=n.type==="dashed"?"url(#comp-arrow-open)":"url(#comp-arrow-end)");let r="";return i.labelPosition&&n.label&&(r=`
                <rect x="${i.labelPosition.x-n.label.length*3.5-4}" y="${i.labelPosition.y-10}" width="${n.label.length*7+8}" height="16" fill="white" fill-opacity="0.85" rx="3" />
                <text x="${i.labelPosition.x}" y="${i.labelPosition.y}" text-anchor="middle" dominant-baseline="middle" fill="${this.theme.colors.textLight}" font-family="${this.theme.fontFamily}" font-size="11" font-style="italic">
                    ${this.escapeXml(n.label)}
                </text>
            `),`
            <g>
                <line x1="${o.x}" y1="${o.y}" x2="${s.x}" y2="${s.y}" stroke="${this.theme.colors.line}" stroke-width="1.3" stroke-dasharray="${a}" marker-end="${c}"/>
                ${r}
            </g>
        `}renderNote(i){let{x:t,y:e,width:n,height:o,note:s}=i,a=12;return`
            <g transform="translate(${t}, ${e})">
                <path d="M0,0 L${n-a},0 L${n},${a} L${n},${o} L0,${o} Z" fill="${this.theme.colors.noteFill}" stroke="${this.theme.colors.noteStroke}" stroke-width="1" />
                <path d="M${n-a},0 L${n-a},${a} L${n},${a}" fill="none" stroke="${this.theme.colors.noteStroke}" stroke-width="1" />
                <text x="10" y="18" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize-1}">
                    ${s.text.split(`
`).map((c,r)=>`<tspan x="10" dy="${r===0?0:"1.3em"}">${this.escapeXml(c)}</tspan>`).join("")}
                </text>
            </g>
        `}escapeXml(i){return i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}renderPort(i,t,e){let{x:n,y:o,width:s,height:a,component:c}=i,r=this.theme.colors.line,h="";if(c.parentId){let l=e.components.find(p=>p.component.name===c.parentId);if(l){let p=n+s/2,d=o+a/2,f=l.x+l.width/2,g=l.y+l.height/2,m=p-f,x=d-g,S=0,C=0,u="middle",k="middle",y=10;Math.abs(m)>=Math.abs(x)?m>0?(S=n-y/2,C=d,u="end"):(S=n+s+y/2,C=d,u="start"):x>0?(S=p,C=o-y/2,k="auto"):(S=p,C=o+a+y,k="hanging");let v=c.label||c.name;h=`<text x="${S}" y="${C}" text-anchor="${u}" dominant-baseline="${k}" fill="${this.theme.colors.text}" font-family="${this.theme.fontFamily}" font-size="${this.theme.fontSize-2}">${this.escapeXml(v)}</text>`}}return`
            <g>
                <rect x="${n}" y="${o}" width="${s}" height="${a}" fill="${r}" stroke="${this.theme.colors.defaultStroke}" stroke-width="1" />
                ${h}
            </g>
        `}};function at(A){let i=new tt,t=new nt;try{let e=i.parse(A);return t.render(e)}catch(e){return gt(e)}}function ct(A){let i=new ot,t=new rt;try{let e=i.parse(A);return t.render(e)}catch(e){return gt(e)}}function gt(A){let t=(A.message||"Unknown error occurred during parsing").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=800,n=100;return`
        <svg width="${e}" height="${n}" viewBox="0 0 ${e} ${n}" xmlns="http://www.w3.org/2000/svg" style="background: white; font-family: sans-serif;">
            <rect width="100%" height="100%" fill="#ffeeee" stroke="#ff0000" stroke-width="2" />
            <text x="20" y="50" fill="#ff0000" font-size="16" font-weight="bold">${t}</text>
        </svg>
    `.trim()}function ft(A){let i=/\b(component|interface|package|node|cloud|database|frame|folder|\[.*?\])\b/.test(A),t=/\b(participant|actor|boundary|control|entity|collections|queue|sequence)\b/.test(A);return i&&!t?ct(A):!i&&t?at(A):/^\[.*?\]/m.test(A)?ct(A):at(A)}function lt(A="pre.seeduml"){if(typeof document>"u")return;document.querySelectorAll(A).forEach(t=>{let e=t.textContent||"",n=ft(e),o=document.createElement("div");o.className="seeduml-diagram",o.innerHTML=n,o.style.display="inline-block",t.parentNode?.replaceChild(o,t)})}function $t(A={}){let{startOnLoad:i=!0,selector:t="pre.seeduml"}=A;i&&(typeof document>"u"||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{lt(t)}):lt(t)))}typeof window<"u"&&(window.seeduml={renderSequenceDiagram:at,renderComponentDiagram:ct,render:ft,renderAll:lt,initialize:$t});var Zt={renderSequenceDiagram:at,renderComponentDiagram:ct,render:ft,renderAll:lt,initialize:$t};export{Zt as default,$t as initialize,ft as render,lt as renderAll,ct as renderComponentDiagram,at as renderSequenceDiagram};
